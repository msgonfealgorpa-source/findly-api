<!DOCTYPE html>
<html lang="ar" dir="rtl" id="main-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Findly Sage Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-glow: rgba(139, 92, 246, 0.5);
            --secondary: #6366f1;
            --bg-dark: #020617;
            --bg-card: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --gradient: linear-gradient(135deg, #6366F1, #A855F7);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        .light-mode {
            --bg-dark: #f8fafc;
            --bg-card: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.05);
            --text: #1e293b;
            --text-muted: #64748b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, transparent 50%);
            color: var(--text);
            font-family: 'Readex Pro', sans-serif;
            margin: 0;
            transition: background 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
            min-height: 100vh;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-tools { display: flex; gap: 10px; }
        .tool-btn {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            color: var(--text);
            width: 42px;
            height: 42px;
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .tool-btn:hover { transform: translateY(-2px); border-color: var(--primary); }
        .lang-menu {
            display: none;
            position: absolute;
            top: 50px;
            left: 0;
            background: #1e293b;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            width: 140px;
            z-index: 2000;
            box-shadow: 0 20px 40px -5px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .lang-item {
            padding: 12px;
            font-size: 0.9rem;
            cursor: pointer;
            color: #e2e8f0;
            text-align: center;
            transition: 0.2s;
        }
        .lang-item:hover { background: var(--primary); color: white; }
        .search-area { padding: 40px 5%; text-align: center; max-width: 800px; margin: 0 auto; }
        .energy-box {
            background: rgba(168, 85, 247, 0.08);
            border: 1px solid rgba(168, 85, 247, 0.3);
            padding: 8px 20px;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        h1#txt-title {
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
            font-size: 2.5rem;
        }
        .light-mode h1#txt-title {
            background: linear-gradient(to right, #1e293b, #475569);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .ai-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 25px;
            justify-content: center;
            font-weight: 600;
            background: rgba(139, 92, 246, 0.05);
            padding: 8px 16px;
            border-radius: 12px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .ai-toggle input { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; }
        .search-wrapper { position: relative; max-width: 600px; margin: 0 auto 20px; }
        .search-input {
            width: 100%;
            padding: 18px 70px;
            border-radius: 24px;
            border: 2px solid var(--glass-border);
            background: var(--bg-card);
            color: var(--text);
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            text-align: center;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15); }
        .mic-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary);
            cursor: pointer;
            font-size: 1.4rem;
            background: none;
            border: none;
            padding: 10px;
            border-radius: 50%;
            transition: 0.3s;
            z-index: 10;
        }
        .mic-icon:hover { background: rgba(139, 92, 246, 0.1); }
        .mic-active { color: #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; animation: pulse 1s infinite; }
        .send-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gradient);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 18px;
            color: #fff;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .send-btn:hover { transform: translateY(-50%) scale(1.05); }
        .ai-options { display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .ai-tag {
            font-size: 0.8rem; padding: 8px 16px; border-radius: 20px;
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            cursor: pointer; color: var(--text-muted); display: flex; align-items: center; gap: 8px;
            transition: 0.3s;
        }
        .ai-tag:hover { background: var(--bg-card); color: var(--primary); border-color: var(--primary); }
        .cat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 600px; margin: 30px auto; }
        .cat-card {
            background: var(--bg-card); border: 1px solid var(--glass-border);
            padding: 15px 10px; border-radius: 20px; cursor: pointer;
            transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .cat-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .cat-card i { font-size: 1.5rem; color: var(--secondary); }
        .cat-card span { font-size: 0.75rem; font-weight: 600; }

        /* ==================== PRODUCT CARD - PROFESSIONAL ==================== */
        .product-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 20px;
            margin-top: 25px;
            text-align: right;
            max-width: 700px;
            margin-left: auto; margin-right: auto;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            animation: slideUp 0.5s ease;
        }
        .product-card img {
            width: 100%;
            height: 180px;
            object-fit: contain;
            background: #fff;
            border-radius: 16px;
            margin-bottom: 15px;
            padding: 10px;
        }
        .product-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.05rem;
            line-height: 1.5;
            color: var(--text);
        }
        .product-card .price {
            font-size: 1.5rem;
            font-weight: 800;
            color: #10b981;
            margin-bottom: 10px;
        }
        .old-price { text-decoration: line-through; opacity: 0.6; margin-right: 6px; font-size: 0.9em; }
        
        /* ==================== VERDICT BADGE ==================== */
        .verdict-badge {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-radius: 16px;
            margin: 15px 0;
            gap: 15px;
        }
        .verdict-badge.strong_buy { background: linear-gradient(135deg, rgba(5, 150, 105, 0.2), rgba(16, 185, 129, 0.1)); border: 2px solid #10b981; }
        .verdict-badge.buy_now { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(34, 197, 94, 0.1)); border: 2px solid #22c55e; }
        .verdict-badge.buy { background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(132, 204, 22, 0.1)); border: 2px solid #84cc16; }
        .verdict-badge.wait { background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(251, 191, 36, 0.1)); border: 2px solid #f59e0b; }
        .verdict-badge.avoid { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1)); border: 2px solid #ef4444; }
        .verdict-badge.smart_wait { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.1)); border: 2px solid #3b82f6; }
        .verdict-badge.consider { background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.1)); border: 2px solid #6366f1; }
        
        .verdict-icon { font-size: 2.5rem; }
        .verdict-info { flex: 1; }
        .verdict-decision { font-size: 1.2rem; font-weight: 800; margin-bottom: 4px; }
        .verdict-reason { font-size: 0.85rem; opacity: 0.9; }
        .verdict-confidence {
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 12px;
            text-align: center;
        }
        .verdict-confidence-value { font-size: 1.5rem; font-weight: 800; }
        .verdict-confidence-label { font-size: 0.7rem; opacity: 0.8; }

        /* ==================== INTELLIGENCE SECTIONS ==================== */
        .intel-section {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            margin: 12px 0;
        }
        .intel-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        .intel-section-title i { font-size: 1.1rem; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .stat-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary);
        }
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .stat-item.success .stat-value { color: #10b981; }
        .stat-item.warning .stat-value { color: #f59e0b; }
        .stat-item.danger .stat-value { color: #ef4444; }
        
        /* Progress Bars */
        .progress-bar-container {
            margin: 10px 0;
        }
        .progress-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .progress-bar-fill.excellent { background: linear-gradient(90deg, #10b981, #22c55e); }
        .progress-bar-fill.good { background: linear-gradient(90deg, #22c55e, #84cc16); }
        .progress-bar-fill.fair { background: linear-gradient(90deg, #eab308, #f59e0b); }
        .progress-bar-fill.poor { background: linear-gradient(90deg, #f59e0b, #ef4444); }
        .progress-bar-fill.bad { background: linear-gradient(90deg, #ef4444, #dc2626); }

        /* ==================== PRICE INTEL ==================== */
        .price-intel-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .price-stat {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }
        .price-stat-value { font-size: 1rem; font-weight: 700; }
        .price-stat-label { font-size: 0.7rem; color: var(--text-muted); margin-top: 3px; }

        /* ==================== TECHNICAL INDICATORS ==================== */
        .tech-indicators {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .tech-indicator {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 8px 14px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .tech-indicator.bullish { border-color: #10b981; color: #10b981; }
        .tech-indicator.bearish { border-color: #ef4444; color: #ef4444; }
        .tech-indicator.neutral { border-color: #f59e0b; color: #f59e0b; }

        /* ==================== TRUST SECTION ==================== */
        .trust-section {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            margin-top: 10px;
        }
        .trust-score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 800;
        }
        .trust-score-circle.high { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 2px solid #10b981; }
        .trust-score-circle.medium { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 2px solid #f59e0b; }
        .trust-score-circle.low { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 2px solid #ef4444; }
        .trust-details { flex: 1; }
        .trust-store-name { font-weight: 600; font-size: 0.95rem; }
        .trust-badge { display: inline-block; padding: 3px 10px; border-radius: 8px; font-size: 0.75rem; margin-top: 4px; }
        .trust-badge.platinum { background: linear-gradient(135deg, #e5e7eb, #d1d5db); color: #1f2937; }
        .trust-badge.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1f2937; }
        .trust-badge.silver { background: linear-gradient(135deg, #e5e7eb, #9ca3af); color: #1f2937; }
        .trust-badge.bronze { background: linear-gradient(135deg, #d97706, #92400e); color: white; }
        .trust-badge.warning { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        /* ==================== FAKE DEAL ALERT ==================== */
        .fake-deal-alert {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
            border: 2px solid rgba(239, 68, 68, 0.5);
            border-radius: 14px;
            padding: 14px;
            margin: 12px 0;
        }
        .fake-deal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .fake-deal-icon { font-size: 1.5rem; }
        .fake-deal-title { font-weight: 700; color: #ef4444; }
        .fake-deal-reasons { font-size: 0.85rem; color: var(--text-muted); }
        .fake-deal-reasons li { margin: 5px 0; }

        /* ==================== RECOMMENDATIONS ==================== */
        .recommendation-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.3s;
        }
        .recommendation-card:hover { background: rgba(255,255,255,0.06); }
        .recommendation-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .recommendation-icon.alternative { background: rgba(59, 130, 246, 0.2); }
        .recommendation-icon.timing { background: rgba(139, 92, 246, 0.2); }
        .recommendation-info { flex: 1; }
        .recommendation-title { font-weight: 600; font-size: 0.9rem; }
        .recommendation-subtitle { font-size: 0.8rem; color: var(--text-muted); }
        .recommendation-savings {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* ==================== PERSONALITY BADGE ==================== */
        .personality-badge {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2));
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 16px;
            padding: 12px 16px;
            margin: 15px auto;
            max-width: 700px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .personality-icon {
            width: 45px;
            height: 45px;
            background: var(--gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .personality-info { flex: 1; }
        .personality-type { font-weight: 700; font-size: 0.95rem; color: var(--primary); }
        .personality-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }

        /* ==================== BUTTONS ==================== */
        .action-btn {
            flex: 1; padding: 14px; border-radius: 14px; font-weight: 700;
            text-align: center; border: none; font-size: 0.95rem; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .buy-now {
            background: var(--gradient); color: #fff; text-decoration: none;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        .buy-now:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .analyze-btn { background: rgba(30, 41, 59, 0.7); border: 1px solid var(--primary); color: var(--primary); }
        .analyze-btn:hover { background: var(--primary); color: white; }
        .watch-btn { background: rgba(245, 158, 11, 0.2); border: 1px solid #f59e0b; color: #f59e0b; }
        .watch-btn:hover { background: #f59e0b; color: white; }

        /* ==================== MODALS ==================== */
        .modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.8); z-index: 3000;
            align-items: center; justify-content: center;
            backdrop-filter: blur(12px);
        }
        .modal-box {
            background: #0f172a; padding: 30px; border-radius: 30px;
            width: 85%; max-width: 450px;
            border: 1px solid var(--glass-border);
            text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            max-height: 80vh; overflow-y: auto;
        }
        .modal-box input {
            width: 100%; padding: 14px; margin: 10px 0; border-radius: 14px;
            background: #1e293b; color: #fff; border: 1px solid var(--glass-border);
            text-align: center; font-family: inherit;
        }
        .modal-box input:focus { border-color: var(--primary); }

        /* ==================== AUTH MODAL ==================== */
        .auth-overlay {
            display: none !important;
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%) !important;
            z-index: 2147483647 !important;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(15px);
            overflow-y: auto;
            padding: 15px 0;
        }
        .auth-container { position: relative; width: 100%; max-width: 420px; padding: 0 15px; margin: auto; }
        .auth-card {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(139, 92, 246, 0.25);
            border-radius: 28px;
            padding: 35px 28px;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.7);
            text-align: center;
            position: relative;
            overflow: hidden;
            margin: 10px auto;
        }
        .auth-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--gradient);
            border-radius: 28px 28px 0 0;
        }
        .auth-logo-wrapper {
            width: 70px; height: 70px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 18px;
            font-size: 2rem;
            color: white;
            box-shadow: 0 12px 30px var(--primary-glow);
        }
        .auth-card h2 { font-size: 1.7rem; font-weight: 800; color: var(--text); margin-bottom: 6px; }
        .auth-card .auth-subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 25px; }
        .input-group-modern { position: relative; margin-bottom: 14px; }
        .input-group-modern .input-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1rem;
            pointer-events: none;
        }
        .input-group-modern input {
            width: 100%;
            padding: 14px 45px 14px 14px;
            background: rgba(255, 255, 255, 0.04);
            border: 1.5px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.95rem;
        }
        .input-group-modern input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(139, 92, 246, 0.08);
        }
        .btn-primary {
            width: 100%;
            padding: 15px;
            background: var(--gradient);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        .auth-divider::before, .auth-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .auth-divider span { padding: 0 15px; }
        .btn-google {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 14px;
            color: var(--text);
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            font-family: inherit;
        }
        .btn-google:hover { background: rgba(255, 255, 255, 0.1); }
        .btn-google img { width: 20px; height: 20px; }
        .auth-switch {
            margin-top: 22px;
            padding-top: 18px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }
        .auth-switch p { color: var(--text-muted); font-size: 0.9rem; margin: 0; }
        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 700;
            cursor: pointer;
        }
        .auth-view {
            position: absolute;
            top: 0; left: 0; right: 0;
            opacity: 0;
            visibility: hidden;
            transform: translateX(30px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .auth-view.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
            position: relative;
        }

        /* ==================== CHAT BOT ==================== */
        .chat-fab {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
            z-index: 999;
            border: none;
            color: white;
            font-size: 1.5rem;
        }
        .chat-fab:hover { transform: scale(1.1); }
        .chat-window {
            position: fixed;
            bottom: 100px;
            left: 25px;
            width: 380px;
            max-width: calc(100vw - 50px);
            height: 520px;
            max-height: 70vh;
            background: #0f172a;
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            display: none;
            flex-direction: column;
            z-index: 998;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .chat-window.active { display: flex; animation: slideUp 0.3s ease; }
        .chat-header {
            background: var(--gradient);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-avatar {
            width: 42px; height: 42px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .chat-title-area { flex: 1; }
        .chat-title-area h4 { margin: 0; font-size: 1rem; }
        .chat-title-area span { font-size: 0.75rem; opacity: 0.8; }
        .chat-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px; height: 32px;
            border-radius: 10px;
            cursor: pointer;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .chat-message.user {
            align-self: flex-end;
            background: var(--gradient);
            color: white;
        }
        .chat-message.assistant {
            align-self: flex-start;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
        }
        .chat-input-area {
            padding: 16px;
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            color: var(--text);
            font-family: inherit;
        }
        .chat-input:focus { border-color: var(--primary); outline: none; }
        .chat-send {
            width: 48px; height: 48px;
            background: var(--gradient);
            border: none;
            border-radius: 14px;
            color: white;
            cursor: pointer;
            font-size: 1.1rem;
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes pulse { 0%, 100% { transform: translateY(-50%) scale(1); } 50% { transform: translateY(-50%) scale(1.1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-ring { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.15); opacity: 0; } }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .cat-grid { grid-template-columns: repeat(3, 1fr); }
            .price-intel-grid { grid-template-columns: repeat(2, 1fr); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .chat-window { left: 10px; right: 10px; bottom: 80px; width: auto; height: 60vh; }
            .chat-fab { bottom: 20px; left: 20px; }
            .verdict-badge { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>

<!-- ========== AUTH MODAL ========== -->
<div id="auth-modal" class="modal auth-overlay">
    <div class="auth-container">
        <div class="auth-card">
            <div id="login-view" class="auth-view active">
                <div class="auth-logo-wrapper"><i class="fa-solid fa-user-astronaut"></i></div>
                <h2>Findly Sage</h2>
                <p class="auth-subtitle" id="login-subtitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹! Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
                <div class="auth-form">
                    <div class="input-group-modern">
                        <input type="email" id="login-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                        <i class="fa-regular fa-envelope input-icon"></i>
                    </div>
                    <div class="input-group-modern">
                        <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                        <i class="fa-solid fa-lock input-icon"></i>
                    </div>
                    <button onclick="handleLogin()" class="btn-primary" id="btn-login">
                        <i class="fa-solid fa-right-to-bracket"></i>
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                    </button>
                </div>
                <div class="auth-divider"><span id="txt-or">Ø£Ùˆ</span></div>
                <button onclick="loginWithGoogle()" class="btn-google" id="btn-google">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    <span id="txt-google-btn">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¬Ù„</span>
                </button>
                <div class="auth-switch">
                    <p id="login-footer-text">
                        Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ
                        <a id="go-to-signup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ <i class="fa-solid fa-arrow-left"></i></a>
                    </p>
                </div>
            </div>
            <div id="signup-view" class="auth-view">
                <div class="auth-logo-wrapper"><i class="fa-solid fa-user-plus"></i></div>
                <h2 id="signup-title">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                <p class="auth-subtitle" id="signup-subtitle">Ø§Ù†Ø¶Ù… Ø¥Ù„ÙŠÙ†Ø§ ÙˆØ§Ø³ØªÙ…ØªØ¹ Ø¨ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ Ø°ÙƒÙŠØ©</p>
                <div class="auth-form">
                    <div class="input-group-modern">
                        <input type="text" id="signup-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
                        <i class="fa-regular fa-user input-icon"></i>
                    </div>
                    <div class="input-group-modern">
                        <input type="email" id="signup-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                        <i class="fa-regular fa-envelope input-icon"></i>
                    </div>
                    <div class="input-group-modern">
                        <input type="password" id="signup-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                        <i class="fa-solid fa-lock input-icon"></i>
                    </div>
                    <button onclick="handleRegister()" class="btn-primary" id="btn-register">
                        <i class="fa-solid fa-user-plus"></i>
                        <span>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</span>
                    </button>
                </div>
                <div class="auth-divider"><span id="txt-or-signup">Ø£Ùˆ</span></div>
                <button onclick="loginWithGoogle()" class="btn-google" id="btn-google-signup">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    <span id="txt-google-btn-signup">Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¬Ù„</span>
                </button>
                <div class="auth-switch">
                    <p id="signup-footer-text">
                        Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ
                        <a id="go-to-login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ <i class="fa-solid fa-arrow-left"></i></a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<header>
    <div class="logo-area">
        <div class="logo">Findly <i class="fa-solid fa-wand-magic-sparkles"></i></div>
    </div>
    <div class="header-tools">
        <button class="tool-btn" onclick="toggleMode()" title="Toggle Theme"><i class="fa-solid fa-circle-half-stroke"></i></button>
        <div style="position: relative;">
            <button class="tool-btn" onclick="toggleLMenu()" title="Language"><i class="fa-solid fa-language"></i></button>
            <div id="l-menu" class="lang-menu">
                <div class="lang-item" onclick="setLang('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</div>
                <div class="lang-item" onclick="setLang('en')">English</div>
                <div class="lang-item" onclick="setLang('fr')">Francais</div>
                <div class="lang-item" onclick="setLang('de')">Deutsch</div>
                <div class="lang-item" onclick="setLang('es')">Espanol</div>
                <div class="lang-item" onclick="setLang('tr')">Turkce</div>
            </div>
        </div>
        <button class="tool-btn" id="logout-btn" onclick="logoutUser()" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></button>
    </div>
</header>

<main class="search-area">
    <div class="energy-box">
        <span id="txt-energy"></span>
        <span id="r-count" style="background:var(--primary); color:#fff; padding:3px 12px; border-radius:20px; font-weight:900; font-size: 0.9rem;">3</span>
        <i class="fa-solid fa-bolt" style="color:#FFD700;"></i>
    </div>
    <h2 id="greeting" style="color: var(--primary); font-size: 1.1rem; margin-bottom: 5px; font-weight: 600;"></h2>
    <h1 id="txt-title"></h1>
    <p id="txt-sub" style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 30px;"></p>
    <div class="ai-toggle">
        <i class="fa-solid fa-brain"></i>
        <span id="txt-deep"></span>
        <input type="checkbox" id="ai-deep-mode">
    </div>
    <div class="search-wrapper">
        <input type="text" id="s-input" class="search-input" placeholder="" onkeypress="if(event.key==='Enter')runSearch()">
        <button id="mic-btn" class="mic-icon" type="button"><i class="fa-solid fa-microphone"></i></button>
        <button class="send-btn" onclick="runSearch()"><i class="fa-solid fa-magnifying-glass"></i></button>
    </div>
    <div class="ai-options">
        <div class="ai-tag" onclick="quickFilter('cheap')"><i class="fa-solid fa-sack-dollar"></i> <span id="tag-cheap"></span></div>
        <div class="ai-tag" onclick="quickFilter('top')"><i class="fa-solid fa-star"></i> <span id="tag-top"></span></div>
        <div class="ai-tag" onclick="quickFilter('new')"><i class="fa-solid fa-fire"></i> <span id="tag-new"></span></div>
    </div>
    <div class="cat-grid">
        <div class="cat-card" onclick="quickSearch('Ø£Ù„Ø¹Ø§Ø¨')"><i class="fa-solid fa-gamepad"></i><span id="cat-game"></span></div>
        <div class="cat-card" onclick="quickSearch('Ø¬Ù…Ø§Ù„')"><i class="fa-solid fa-sparkles"></i><span id="cat-beauty"></span></div>
        <div class="cat-card" onclick="quickSearch('Ù…Ù†Ø²Ù„ Ø°ÙƒÙŠ')"><i class="fa-solid fa-house-laptop"></i><span id="cat-home"></span></div>
        <div class="cat-card" onclick="quickSearch('Ù‡ÙˆØ§ØªÙ')"><i class="fa-solid fa-mobile-screen-button"></i><span id="cat-c1"></span></div>
        <div class="cat-card" onclick="quickSearch('Ù„Ø§Ø¨ØªÙˆØ¨')"><i class="fa-solid fa-laptop"></i><span id="cat-c2"></span></div>
        <div class="cat-card" onclick="quickSearch('Ø³Ø§Ø¹Ø§Øª')"><i class="fa-solid fa-stopwatch"></i><span id="cat-c4"></span></div>
    </div>
    <div id="status" style="display:none; color:var(--primary); font-weight:bold; margin-top:30px; font-size: 1.1rem; text-align: center;"></div>
    <div id="personality-container" style="display: none;"></div>
    <div id="results"></div>
</main>

<!-- Chat Bot -->
<button id="chat-fab" class="chat-fab" type="button"><i class="fa-solid fa-comments" id="chat-fab-icon"></i></button>
<div id="chat-window" class="chat-window">
    <div class="chat-header">
        <div class="chat-avatar">ğŸ¤–</div>
        <div class="chat-title-area">
            <h4 id="chat-title">Sage AI</h4>
            <span id="chat-status">Online</span>
        </div>
        <button class="chat-close" type="button" id="chat-close-btn">âœ•</button>
    </div>
    <div class="chat-messages" id="chat-messages">
        <div class="chat-message assistant" id="chat-welcome"></div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chat-input" class="chat-input" placeholder="" onkeypress="if(event.key==='Enter')sendChatMessage()">
        <button class="chat-send" id="chat-send" type="button"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<!-- Profile Modal -->
<div class="modal" id="p-modal">
    <div class="modal-box">
        <h3 id="p-head" style="margin-top:0;"></h3>
        <label id="lbl-name" style="font-size:0.85rem; display:block; margin-bottom:5px; opacity:0.7;"></label>
        <input type="text" id="in-name" placeholder="">
        <label id="lbl-budget" style="font-size:0.85rem; display:block; margin-top:15px; margin-bottom:5px; opacity:0.7;"></label>
        <input type="number" id="in-budget" placeholder="">
        <button class="action-btn buy-now" onclick="saveSet()" style="width:100%; margin-top:20px;" id="btn-save-settings"></button>
    </div>
</div>

<!-- Firebase Module Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyCI_q5lkgRY4133ua4RlG5TeiCqJ5N5KTU",
    authDomain: "findly-ede17.firebaseapp.com",
    projectId: "findly-ede17",
    storageBucket: "findly-ede17.firebasestorage.app",
    messagingSenderId: "503212830017",
    appId: "1:503212830017:web:9afb64c19822bbe7f645c0",
    measurementId: "G-X1Q3WDP50N"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

window.loginWithGoogle = async () => {
    try { await signInWithPopup(auth, provider); } catch (error) { alert("Error: " + error.message); }
};

window.handleLogin = async () => {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    if (!email || !password) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    try { await signInWithEmailAndPassword(auth, email, password); }
    catch (error) { alert('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message); }
};

window.handleRegister = async () => {
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    if (!email || !password) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    if (password.length < 6) return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
    try { await createUserWithEmailAndPassword(auth, email, password); alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!'); }
    catch (error) { alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ' + error.message); }
};

window.logoutUser = () => {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        signOut(auth).then(() => { location.reload(); });
    }
};

onAuthStateChanged(auth, (user) => {
    const overlay = document.getElementById('auth-modal');
    if (user) {
        overlay.style.setProperty('display', 'none', 'important');
        document.body.style.overflow = 'auto';
        localStorage.setItem('findly_uid', user.uid);
    } else {
        overlay.style.setProperty('display', 'flex', 'important');
        document.body.style.overflow = 'hidden';
    }
});

window.firebaseAuth = auth;
window.firebaseApp = app;

window.getAuthToken = async function() {
    const user = auth.currentUser;
    if (!user) return null;
    try { return await user.getIdToken(); } catch (e) { return null; }
};

window.getCurrentUser = function() { return auth.currentUser; };
</script>

<!-- Main Application Script -->
<script>
const API = "https://findly-api-production.up.railway.app";

// Translations Dictionary
const dict = {
    ar: {
        ui: {
            hero_tagline: "Ù‚Ø±Ø§Ø±Ø§Øª Ø´Ø±Ø§Ø¡ Ø£Ø°ÙƒÙ‰ ØªØ¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§",
            title: "Ù…Ø³ØªØ´Ø§Ø±Ùƒ Ø§Ù„Ø­ÙƒÙŠÙ…", sub: "Ø¯Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ", energy: "Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù‚Ù„",
            welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ", game: "Ø£Ù„Ø¹Ø§Ø¨", beauty: "Ø¬Ù…Ø§Ù„", home: "Ù…Ù†Ø²Ù„ Ø°ÙƒÙŠ", c1: "Ù‡ÙˆØ§ØªÙ", c2: "Ù„Ø§Ø¨ØªÙˆØ¨", c4: "Ø³Ø§Ø¹Ø§Øª",
            cheap: "Ø§Ù‚ØªØµØ§Ø¯ÙŠ", top: "Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹", new: "Ø­Ø¯ÙŠØ« Ø¬Ø¯Ø§Ù‹", deep: "ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ",
            slow: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...", noResults: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬", errorFetching: "âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬",
            buy: "Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù† ğŸ›’", watch: "Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³Ø¹Ø± ğŸ””", analyze: "ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ù…ÙØµÙ„"
        },
        search: {
            priceIntel: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±", valueIntel: "Ø§Ù„Ù‚ÙŠÙ…Ø©", trendIntel: "Ø§Ù„Ø§ØªØ¬Ø§Ù‡",
            trustIntel: "Ø§Ù„Ø«Ù‚Ø© ÙˆØ§Ù„Ù…Ø®Ø§Ø·Ø±", personalityIntel: "Ø´Ø®ØµÙŠØªÙƒ", recommendationIntel: "Ø§Ù„ØªÙˆØµÙŠØ§Øª",
            marketIntel: "Ø§Ù„Ø³ÙˆÙ‚", historicalIntel: "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ",
            avgPrice: "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±", minPrice: "Ø£Ù‚Ù„ Ø³Ø¹Ø±", maxPrice: "Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±", median: "Ø§Ù„ÙˆØ³ÙŠØ·",
            competitors: "Ø§Ù„Ù…Ù†Ø§ÙØ³ÙŠÙ†", percentile: "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø³Ø¨ÙŠ", discount: "Ø§Ù„Ø®ØµÙ…",
            savings: "Ø§Ù„ØªÙˆÙÙŠØ±", savingsAmount: "Ù…Ø¨Ù„Øº Ø§Ù„ØªÙˆÙÙŠØ±",
            trend: "Ø§Ù„Ø§ØªØ¬Ø§Ù‡", trendRising: "ØµØ§Ø¹Ø¯", trendFalling: "Ù‡Ø§Ø¨Ø·", trendStable: "Ù…Ø³ØªÙ‚Ø±",
            prediction: "Ø§Ù„ØªÙˆÙ‚Ø¹", expectedPrice: "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹",
            rsi: "RSI", macd: "MACD", volatility: "Ø§Ù„ØªÙ‚Ù„Ø¨",
            trustScore: "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø«Ù‚Ø©", riskLevel: "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©",
            lowRisk: "Ù…Ù†Ø®ÙØ¶", mediumRisk: "Ù…ØªÙˆØ³Ø·", highRisk: "Ø¹Ø§Ù„ÙŠ",
            bestStore: "Ø£ÙØ¶Ù„ Ù…ØªØ¬Ø±", bestPrice: "Ø£ÙØ¶Ù„ Ø³Ø¹Ø±",
            decision: "Ø§Ù„Ù‚Ø±Ø§Ø±", confidence: "Ø§Ù„Ø«Ù‚Ø©", urgency: "Ø§Ù„Ø¥Ù„Ø­Ø§Ø­",
            strongBuy: "Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠ", buyNow: "Ø§Ø´ØªØ±ÙŠ Ø§Ù„Ø¢Ù†", buy: "Ø§Ø´ØªØ±Ù",
            wait: "Ø§Ù†ØªØ¸Ø±", avoid: "ØªØ¬Ù†Ø¨", smartWait: "Ø§Ù†ØªØ¸Ø§Ø± Ø°ÙƒÙŠ", consider: "ÙÙƒØ±",
            excellentDeal: "ØµÙÙ‚Ø© Ù…Ù…ØªØ§Ø²Ø©", goodDeal: "ØµÙÙ‚Ø© Ø¬ÙŠØ¯Ø©", fairPrice: "Ø³Ø¹Ø± Ø¹Ø§Ø¯Ù„",
            overpriced: "Ø³Ø¹Ø± Ù…Ø±ØªÙØ¹", suspicious: "Ù…Ø´Ø¨ÙˆÙ‡",
            historicalLow: "Ø£Ù‚Ù„ Ø³Ø¹Ø± ØªØ§Ø±ÙŠØ®ÙŠ", historicalHigh: "Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± ØªØ§Ø±ÙŠØ®ÙŠ",
            alternatives: "Ø§Ù„Ø¨Ø¯Ø§Ø¦Ù„", noAlternatives: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø¯Ø§Ø¦Ù„ Ø£Ø±Ø®Øµ"
        }
    },
    en: {
        ui: {
            hero_tagline: "Smarter buying decisions start here",
            title: "Sage Advisor", sub: "Your smart shopping guide", energy: "Sage Energy",
            welcome: "Welcome,", game: "Gaming", beauty: "Beauty", home: "Smart Home", c1: "Phones", c2: "Laptops", c4: "Watches",
            cheap: "Budget", top: "Top Rated", new: "Newest", deep: "AI Deep Mode",
            slow: "Searching...", noResults: "No results found", errorFetching: "âŒ Error fetching results",
            buy: "Buy Now ğŸ›’", watch: "Watch Price ğŸ””", analyze: "ğŸ“Š Detailed Analysis"
        },
        search: {
            priceIntel: "Price Analysis", valueIntel: "Value", trendIntel: "Trend",
            trustIntel: "Trust & Risks", personalityIntel: "Your Personality", recommendationIntel: "Recommendations",
            marketIntel: "Market", historicalIntel: "Price History",
            avgPrice: "Average Price", minPrice: "Min Price", maxPrice: "Max Price", median: "Median",
            competitors: "Competitors", percentile: "Market Position", discount: "Discount",
            savings: "Savings", savingsAmount: "Savings Amount",
            trend: "Trend", trendRising: "Rising", trendFalling: "Falling", trendStable: "Stable",
            prediction: "Prediction", expectedPrice: "Expected Price",
            rsi: "RSI", macd: "MACD", volatility: "Volatility",
            trustScore: "Trust Score", riskLevel: "Risk Level",
            lowRisk: "Low", mediumRisk: "Medium", highRisk: "High",
            bestStore: "Best Store", bestPrice: "Best Price",
            decision: "Decision", confidence: "Confidence", urgency: "Urgency",
            strongBuy: "Strong Buy", buyNow: "Buy Now", buy: "Buy",
            wait: "Wait", avoid: "Avoid", smartWait: "Smart Wait", consider: "Consider",
            excellentDeal: "Excellent Deal", goodDeal: "Good Deal", fairPrice: "Fair Price",
            overpriced: "Overpriced", suspicious: "Suspicious",
            historicalLow: "Historical Low", historicalHigh: "Historical High",
            alternatives: "Alternatives", noAlternatives: "No cheaper alternatives"
        }
    },
    fr: {
        ui: { hero_tagline: "Decisions d'achat plus intelligentes", title: "Conseiller Sage", sub: "Votre guide d'achat intelligent", energy: "Energie", welcome: "Bienvenue,", game: "Jeux", beauty: "Beaute", home: "Maison", c1: "Telephones", c2: "PC", c4: "Montres", cheap: "Economique", top: "Top", new: "Nouveautes", deep: "Mode IA", slow: "Recherche...", noResults: "Aucun resultat", errorFetching: "âŒ Erreur", buy: "Acheter ğŸ›’", watch: "Surveiller ğŸ””", analyze: "ğŸ“Š Analyse" },
        search: { priceIntel: "Analyse Prix", valueIntel: "Valeur", trendIntel: "Tendance", trustIntel: "Confiance", personalityIntel: "Personnalite", recommendationIntel: "Recommandations", marketIntel: "Marche", historicalIntel: "Historique", avgPrice: "Prix moyen", minPrice: "Prix min", maxPrice: "Prix max", median: "Median", competitors: "Concurrents", percentile: "Position", discount: "Remise", savings: "Economie", savingsAmount: "Montant economise", trend: "Tendance", trendRising: "Hausse", trendFalling: "Baisse", trendStable: "Stable", prediction: "Prediction", expectedPrice: "Prix attendu", rsi: "RSI", macd: "MACD", volatility: "Volatilite", trustScore: "Score confiance", riskLevel: "Niveau risque", lowRisk: "Faible", mediumRisk: "Moyen", highRisk: "Eleve", bestStore: "Meilleur magasin", bestPrice: "Meilleur prix", decision: "Decision", confidence: "Confiance", urgency: "Urgence", strongBuy: "Achat fort", buyNow: "Acheter maintenant", buy: "Acheter", wait: "Attendre", avoid: "Eviter", smartWait: "Attente intelligente", consider: "Considerer", excellentDeal: "Excellente offre", goodDeal: "Bonne offre", fairPrice: "Prix juste", overpriced: "Trop cher", suspicious: "Suspect", historicalLow: "Plus bas historique", historicalHigh: "Plus haut historique", alternatives: "Alternatives", noAlternatives: "Pas d'alternatives" }
    },
    de: {
        ui: { hero_tagline: "Intelligentere Kaufentscheidungen", title: "Weiser Berater", sub: "Ihr Einkaufsfuhrer", energy: "Energie", welcome: "Willkommen,", game: "Spiele", beauty: "Schonheit", home: "Heim", c1: "Handys", c2: "Laptops", c4: "Uhren", cheap: "Budget", top: "Top", new: "Neu", deep: "KI Modus", slow: "Suche...", noResults: "Keine Ergebnisse", errorFetching: "âŒ Fehler", buy: "Kaufen ğŸ›’", watch: "Beobachten ğŸ””", analyze: "ğŸ“Š Analyse" },
        search: { priceIntel: "Preisanalyse", valueIntel: "Wert", trendIntel: "Trend", trustIntel: "Vertrauen", personalityIntel: "Personlichkeit", recommendationIntel: "Empfehlungen", marketIntel: "Markt", historicalIntel: "Historie", avgPrice: "Durchschnittspreis", minPrice: "Min Preis", maxPrice: "Max Preis", median: "Median", competitors: "Wettbewerber", percentile: "Position", discount: "Rabatt", savings: "Ersparnis", savingsAmount: "Ersparnisbetrag", trend: "Trend", trendRising: "Steigend", trendFalling: "Fallend", trendStable: "Stabil", prediction: "Vorhersage", expectedPrice: "Erwarteter Preis", rsi: "RSI", macd: "MACD", volatility: "Volatilitat", trustScore: "Vertrauensscore", riskLevel: "Risikoniveau", lowRisk: "Niedrig", mediumRisk: "Mittel", highRisk: "Hoch", bestStore: "Bester Laden", bestPrice: "Bester Preis", decision: "Entscheidung", confidence: "Vertrauen", urgency: "Dringlichkeit", strongBuy: "Starker Kauf", buyNow: "Jetzt kaufen", buy: "Kaufen", wait: "Warten", avoid: "Vermeiden", smartWait: "Intelligentes Warten", consider: "Erwagen", excellentDeal: "Ausgezeichnetes Angebot", goodDeal: "Gutes Angebot", fairPrice: "Fairer Preis", overpriced: "Uberteuert", suspicious: "Verdachtig", historicalLow: "Historischer Tiefststand", historicalHigh: "Historischer Hochststand", alternatives: "Alternativen", noAlternatives: "Keine gunstigeren Alternativen" }
    },
    es: {
        ui: { hero_tagline: "Decisiones de compra mas inteligentes", title: "Consejero Sabio", sub: "Tu guia de compras", energy: "Energia", welcome: "Bienvenido,", game: "Juegos", beauty: "Belleza", home: "Hogar", c1: "Telefonos", c2: "Laptops", c4: "Relojes", cheap: "Economico", top: "Top", new: "Nuevo", deep: "Modo IA", slow: "Buscando...", noResults: "Sin resultados", errorFetching: "âŒ Error", buy: "Comprar ğŸ›’", watch: "Vigilar ğŸ””", analyze: "ğŸ“Š Analisis" },
        search: { priceIntel: "Analisis de Precio", valueIntel: "Valor", trendIntel: "Tendencia", trustIntel: "Confianza", personalityIntel: "Personalidad", recommendationIntel: "Recomendaciones", marketIntel: "Mercado", historicalIntel: "Historial", avgPrice: "Precio promedio", minPrice: "Precio min", maxPrice: "Precio max", median: "Mediana", competitors: "Competidores", percentile: "Posicion", discount: "Descuento", savings: "Ahorro", savingsAmount: "Cantidad ahorrada", trend: "Tendencia", trendRising: "Subiendo", trendFalling: "Bajando", trendStable: "Estable", prediction: "Prediccion", expectedPrice: "Precio esperado", rsi: "RSI", macd: "MACD", volatility: "Volatilidad", trustScore: "Puntuacion de confianza", riskLevel: "Nivel de riesgo", lowRisk: "Bajo", mediumRisk: "Medio", highRisk: "Alto", bestStore: "Mejor tienda", bestPrice: "Mejor precio", decision: "Decision", confidence: "Confianza", urgency: "Urgencia", strongBuy: "Compra fuerte", buyNow: "Comprar ahora", buy: "Comprar", wait: "Esperar", avoid: "Evitar", smartWait: "Espera inteligente", consider: "Considerar", excellentDeal: "Oferta excelente", goodDeal: "Buena oferta", fairPrice: "Precio justo", overpriced: "Caro", suspicious: "Sospechoso", historicalLow: "Minimo historico", historicalHigh: "Maximo historico", alternatives: "Alternativas", noAlternatives: "Sin alternativas mas baratas" }
    },
    tr: {
        ui: { hero_tagline: "Daha akilli satin alma kararlarÄ±", title: "Bilge Danisman", sub: "Akilli alisveris rehberiniz", energy: "Enerji", welcome: "Hos geldiniz,", game: "Oyunlar", beauty: "Guzellik", home: "Ev", c1: "Telefonlar", c2: "Laptoplar", c4: "Saatler", cheap: "Ekonomik", top: "En iyi", new: "Yeni", deep: "AI Modu", slow: "Araniyor...", noResults: "Sonuc yok", errorFetching: "âŒ Hata", buy: "Al ğŸ›’", watch: "Izle ğŸ””", analyze: "ğŸ“Š Analiz" },
        search: { priceIntel: "Fiyat Analizi", valueIntel: "Deger", trendIntel: "Trend", trustIntel: "Guven", personalityIntel: "Kisilik", recommendationIntel: "Oneriler", marketIntel: "Pazar", historicalIntel: "Gecmis", avgPrice: "Ortalama fiyat", minPrice: "Min fiyat", maxPrice: "Max fiyat", median: "Medyan", competitors: "Rakipler", percentile: "Konum", discount: "Indirim", savings: "Tasarruf", savingsAmount: "Tasarruf miktari", trend: "Trend", trendRising: "Yukselis", trendFalling: "Dusus", trendStable: "Kararli", prediction: "Tahmin", expectedPrice: "Beklenen fiyat", rsi: "RSI", macd: "MACD", volatility: "Volatilite", trustScore: "Guven skoru", riskLevel: "Risk seviyesi", lowRisk: "Dusuk", mediumRisk: "Orta", highRisk: "Yuksek", bestStore: "En iyi magaza", bestPrice: "En iyi fiyat", decision: "Karar", confidence: "Guven", urgency: "Aciliyet", strongBuy: "Guclu alis", buyNow: "Simdi al", buy: "Al", wait: "Bekle", avoid: "Kacin", smartWait: "Akilli bekleme", consider: "Dusun", excellentDeal: "Mukemmel firsat", goodDeal: "Iyi firsat", fairPrice: "Adil fiyat", overpriced: "Pahali", suspicious: "Supheli", historicalLow: "Tarihi dusuk", historicalHigh: "Tarihi yuksek", alternatives: "Alternatifler", noAlternatives: "Daha ucuz alternatif yok" }
    }
};

window.dict = dict;

let lang = localStorage.getItem('findly_lang') || 'ar';
let chatHistory = [];
let isChatOpen = false;
let voiceRecognition = null;

// ===== UTILITY FUNCTIONS =====
function cleanPrice(p) {
    if (!p) return 0;
    if (typeof p === 'number') return p;
    const cleaned = parseFloat(p.toString().replace(/[^0-9.]/g, ''));
    return isNaN(cleaned) ? 0 : cleaned;
}

function getProgressBarClass(score) {
    if (score >= 80) return 'excellent';
    if (score >= 60) return 'good';
    if (score >= 40) return 'fair';
    if (score >= 20) return 'poor';
    return 'bad';
}

function getVerdictClass(decision) {
    const decisionMap = {
        'STRONG_BUY': 'strong_buy',
        'BUY_NOW': 'buy_now',
        'BUY': 'buy',
        'WAIT': 'wait',
        'AVOID': 'avoid',
        'CAUTION': 'wait',
        'SMART_WAIT': 'smart_wait',
        'CONSIDER': 'consider'
    };
    return decisionMap[decision] || 'consider';
}

function getVerdictIcon(decision) {
    const iconMap = {
        'STRONG_BUY': 'ğŸš€',
        'BUY_NOW': 'âœ…',
        'BUY': 'ğŸ‘',
        'WAIT': 'â³',
        'AVOID': 'ğŸš¨',
        'CAUTION': 'âš ï¸',
        'SMART_WAIT': 'ğŸ§ ',
        'CONSIDER': 'ğŸ¤”'
    };
    return iconMap[decision] || 'ğŸ“Š';
}

function getTrustClass(score) {
    if (score >= 70) return 'high';
    if (score >= 40) return 'medium';
    return 'low';
}

function htmlspecialchars(str) {
    if (!str) return '';
    return str.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ===== RENDER PRODUCT CARD WITH FULL INTELLIGENCE =====
function renderProductCard(product, T) {
    const intel = product.intelligence || {};
    const verdict = intel.finalVerdict || {};
    const priceIntel = intel.priceIntel || {};
    const valueIntel = intel.valueIntel || {};
    const trendIntel = intel.trendIntel || {};
    const trustIntel = intel.trustIntel || {};
    const merchantTrust = trustIntel.merchantTrust || {};
    const fakeDealCheck = trustIntel.fakeDealCheck || {};
    const marketIntel = intel.marketIntel || {};
    const historicalIntel = intel.historicalIntel || {};
    const personalityIntel = intel.personalityIntel || {};
    const recommendationIntel = intel.recommendationIntel || {};
    
    const priceVal = cleanPrice(product.price);
    const verdictClass = getVerdictClass(verdict.decision);
    const verdictIcon = getVerdictIcon(verdict.decision);
    
    let html = `
    <div class="product-card">
        <img src="${product.thumbnail || ''}" onerror="this.src='https://via.placeholder.com/200'" alt="${htmlspecialchars(product.title)}">
        <h3>${htmlspecialchars(product.title)}</h3>
        <div class="price">
            ${priceIntel.original && priceIntel.original > priceVal ? `<span class="old-price">$${priceIntel.original}</span>` : ''}
            $${priceVal || 'â€”'}
            ${priceIntel.discount > 0 ? `<span style="font-size:0.7em;background:#10b981;color:white;padding:3px 8px;border-radius:8px;margin-right:8px;">-${priceIntel.discount}%</span>` : ''}
        </div>
    `;
    
    // ===== VERDICT BADGE =====
    html += `
        <div class="verdict-badge ${verdictClass}">
            <span class="verdict-icon">${verdictIcon}</span>
            <div class="verdict-info">
                <div class="verdict-decision">${verdict.reason || T.decision}</div>
                <div class="verdict-reason">
                    ${verdict.savingsPercent > 0 ? `ğŸ’° ØªÙˆÙÙŠØ± ${verdict.savingsPercent}%` : ''}
                    ${verdict.urgency === 'high' ? 'âš¡ Ø¥Ù„Ø­Ø§Ø­ Ø¹Ø§Ù„ÙŠ' : verdict.urgency === 'low' ? 'â³ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : ''}
                </div>
            </div>
            <div class="verdict-confidence">
                <div class="verdict-confidence-value">${verdict.confidence || 0}%</div>
                <div class="verdict-confidence-label">${T.confidence}</div>
            </div>
        </div>
    `;
    
    // ===== FAKE DEAL ALERT =====
    if (fakeDealCheck.isSuspicious) {
        html += `
        <div class="fake-deal-alert">
            <div class="fake-deal-header">
                <span class="fake-deal-icon">ğŸš¨</span>
                <span class="fake-deal-title">ØªÙ†Ø¨ÙŠÙ‡: ØµÙÙ‚Ø© Ù…Ø´Ø¨ÙˆÙ‡Ø©!</span>
            </div>
            <ul class="fake-deal-reasons">
                ${fakeDealCheck.redFlags ? fakeDealCheck.redFlags.slice(0, 3).map(f => `<li>${f}</li>`).join('') : ''}
            </ul>
        </div>
        `;
    }
    
    // ===== PRICE INTELLIGENCE SECTION =====
    html += `
        <div class="intel-section">
            <div class="intel-section-title">
                <i class="fa-solid fa-chart-line"></i>
                ${T.priceIntel}
            </div>
            <div class="price-intel-grid">
                <div class="price-stat">
                    <div class="price-stat-value">$${priceIntel.average || 'â€”'}</div>
                    <div class="price-stat-label">${T.avgPrice}</div>
                </div>
                <div class="price-stat">
                    <div class="price-stat-value">$${priceIntel.min || 'â€”'}</div>
                    <div class="price-stat-label">${T.minPrice}</div>
                </div>
                <div class="price-stat">
                    <div class="price-stat-value">$${priceIntel.max || 'â€”'}</div>
                    <div class="price-stat-label">${T.maxPrice}</div>
                </div>
                <div class="price-stat">
                    <div class="price-stat-value">$${priceIntel.median || 'â€”'}</div>
                    <div class="price-stat-label">${T.median}</div>
                </div>
            </div>
            <div class="progress-bar-container" style="margin-top: 12px;">
                <div class="progress-bar-label">
                    <span>Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙÙ‚Ø©</span>
                    <span>${priceIntel.score || 50}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-bar-fill ${getProgressBarClass(priceIntel.score)}" style="width: ${priceIntel.score || 50}%"></div>
                </div>
            </div>
            <div class="stats-grid" style="margin-top: 12px;">
                <div class="stat-item">
                    <div class="stat-value">${priceIntel.percentile || 50}%</div>
                    <div class="stat-label">${T.percentile}</div>
                </div>
                <div class="stat-item success">
                    <div class="stat-value">${priceIntel.savingsPercent || 0}%</div>
                    <div class="stat-label">${T.savings}</div>
                </div>
            </div>
        </div>
    `;
    
    // ===== TREND INTELLIGENCE =====
    if (trendIntel.trend) {
        const trendLabel = trendIntel.trend === 'rising' ? T.trendRising : 
                          trendIntel.trend === 'falling' ? T.trendFalling : T.trendStable;
        const trendIcon = trendIntel.trend === 'rising' ? 'ğŸ“ˆ' : 
                         trendIntel.trend === 'falling' ? 'ğŸ“‰' : 'â¡ï¸';
        
        html += `
        <div class="intel-section">
            <div class="intel-section-title">
                <i class="fa-solid fa-arrow-trend-up"></i>
                ${T.trendIntel}
            </div>
            <div class="stats-grid">
                <div class="stat-item ${trendIntel.trend === 'falling' ? 'success' : trendIntel.trend === 'rising' ? 'warning' : ''}">
                    <div class="stat-value">${trendIcon} ${trendLabel}</div>
                    <div class="stat-label">${T.trend}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${trendIntel.confidence || 50}%</div>
                    <div class="stat-label">${T.confidence}</div>
                </div>
            </div>
            ${trendIntel.technicalIndicators ? `
            <div class="tech-indicators">
                ${trendIntel.technicalIndicators.rsi ? `
                <div class="tech-indicator ${trendIntel.technicalIndicators.rsiSignal === 'oversold' ? 'bullish' : trendIntel.technicalIndicators.rsiSignal === 'overbought' ? 'bearish' : 'neutral'}">
                    ${T.rsi}: ${Math.round(trendIntel.technicalIndicators.rsi)}
                </div>
                ` : ''}
                ${trendIntel.technicalIndicators.macd ? `
                <div class="tech-indicator ${trendIntel.technicalIndicators.macd === 'bullish' ? 'bullish' : 'bearish'}">
                    MACD: ${trendIntel.technicalIndicators.macd === 'bullish' ? 'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ' : 'Ø³Ù„Ø¨ÙŠ'}
                </div>
                ` : ''}
                ${trendIntel.technicalIndicators.volatility ? `
                <div class="tech-indicator neutral">
                    ${T.volatility}: ${trendIntel.technicalIndicators.volatility === 'high' ? 'Ø¹Ø§Ù„ÙŠ' : trendIntel.technicalIndicators.volatility === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'Ù…Ù†Ø®ÙØ¶'}
                </div>
                ` : ''}
            </div>
            ` : ''}
        </div>
        `;
    }
    
    // ===== TRUST INTELLIGENCE =====
    html += `
        <div class="intel-section">
            <div class="intel-section-title">
                <i class="fa-solid fa-shield-halved"></i>
                ${T.trustIntel}
            </div>
            <div class="trust-section">
                <div class="trust-score-circle ${getTrustClass(merchantTrust.trustScore || 50)}">
                    ${merchantTrust.trustScore || 50}%
                </div>
                <div class="trust-details">
                    <div class="trust-store-name">ğŸª ${merchantTrust.store || product.source || 'Unknown'}</div>
                    <div class="trust-badge ${merchantTrust.badge?.level || 'bronze'}">${merchantTrust.badge?.label || 'ØªÙ‚ÙŠÙŠÙ… Ø£Ø³Ø§Ø³ÙŠ'}</div>
                </div>
            </div>
            <div class="stats-grid" style="margin-top: 10px;">
                <div class="stat-item ${fakeDealCheck.riskScore > 50 ? 'danger' : fakeDealCheck.riskScore > 25 ? 'warning' : 'success'}">
                    <div class="stat-value">${fakeDealCheck.riskScore || 0}%</div>
                    <div class="stat-label">${T.riskLevel}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${fakeDealCheck.riskLevel === 'low' ? T.lowRisk : fakeDealCheck.riskLevel === 'medium' ? T.mediumRisk : T.highRisk}</div>
                    <div class="stat-label">${T.trustScore}</div>
                </div>
            </div>
        </div>
    `;
    
    // ===== MARKET INTELLIGENCE - ALTERNATIVES =====
    if (marketIntel.alternatives && marketIntel.alternatives.length > 0) {
        html += `
        <div class="intel-section">
            <div class="intel-section-title">
                <i class="fa-solid fa-store"></i>
                ${T.alternatives}
            </div>
        `;
        marketIntel.alternatives.slice(0, 3).forEach(alt => {
            html += `
            <div class="recommendation-card">
                <div class="recommendation-icon alternative">ğŸª</div>
                <div class="recommendation-info">
                    <div class="recommendation-title">${alt.store}</div>
                    <div class="recommendation-subtitle">$${alt.price}</div>
                </div>
                ${alt.savings > 0 ? `<div class="recommendation-savings">-${alt.savings}%</div>` : ''}
            </div>
            `;
        });
        html += `</div>`;
    }
    
    // ===== HISTORICAL INTELLIGENCE =====
    if (historicalIntel && historicalIntel.lowest) {
        html += `
        <div class="intel-section">
            <div class="intel-section-title">
                <i class="fa-solid fa-clock-rotate-left"></i>
                ${T.historicalIntel}
            </div>
            <div class="stats-grid">
                <div class="stat-item success">
                    <div class="stat-value">$${historicalIntel.lowest}</div>
                    <div class="stat-label">${T.historicalLow}</div>
                </div>
                <div class="stat-item danger">
                    <div class="stat-value">$${historicalIntel.highest}</div>
                    <div class="stat-label">${T.historicalHigh}</div>
                </div>
            </div>
            ${historicalIntel.isHistoricalLow ? `<div style="margin-top:10px;color:#10b981;font-weight:600;">ğŸ† Ù‡Ø°Ø§ Ø£Ù‚Ù„ Ø£Ùˆ Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø£Ù‚Ù„ Ø³Ø¹Ø± ØªØ§Ø±ÙŠØ®ÙŠ!</div>` : ''}
        </div>
        `;
    }
    
    // ===== BEST STORE INFO =====
    if (verdict.bestStore && verdict.bestPrice) {
        html += `
        <div class="intel-section" style="background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3);">
            <div class="intel-section-title" style="color: #10b981;">
                <i class="fa-solid fa-trophy"></i>
                Ø£ÙØ¶Ù„ Ø®ÙŠØ§Ø±
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" style="color: #10b981;">${verdict.bestStore}</div>
                    <div class="stat-label">${T.bestStore}</div>
                </div>
                <div class="stat-item success">
                    <div class="stat-value">$${verdict.bestPrice}</div>
                    <div class="stat-label">${T.bestPrice}</div>
                </div>
            </div>
        </div>
        `;
    }
    
    // ===== ACTION BUTTONS =====
    html += `
        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
            <button class="action-btn watch-btn" onclick="addToWatch('${htmlspecialchars(product.title)}', '${priceVal}', '${product.link || ''}')" style="flex: 1;">
                ğŸ”” ${T.watch}
            </button>
    `;
    
    const bestLink = verdict.bestLink || product.link;
    if (bestLink && bestLink.startsWith('http')) {
        html += `
            <a class="action-btn buy-now" href="${API}/go?url=${encodeURIComponent(bestLink)}" target="_blank" style="flex: 2;">
                ${T.buy}
            </a>
        `;
    }
    
    html += `
        </div>
    </div>
    `;
    
    return html;
}

// ===== SEARCH FUNCTION =====
async function runSearch() {
    const q = document.getElementById('s-input').value.trim();
    const status = document.getElementById('status');
    const resultsBox = document.getElementById('results');
    const personalityContainer = document.getElementById('personality-container');

    if (!q) return;

    const T = dict[lang]?.search || dict.en.search;
    const UI = dict[lang]?.ui || dict.en.ui;

    status.style.display = 'block';
    status.innerText = 'ğŸ” ' + UI.slow;
    resultsBox.innerHTML = '';
    personalityContainer.style.display = 'none';

    try {
        let token = null;
        try { if (window.getAuthToken) token = await window.getAuthToken(); } catch (e) {}

        const headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;

        const res = await fetch(API + '/search?q=' + encodeURIComponent(q) + '&lang=' + lang, { headers });
        const data = await res.json().catch(() => ({}));

        if (res.status === 429 || data.error === 'ENERGY_EMPTY') {
            status.innerHTML = `
                <div class="upgrade-section">
                    <h3>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</h3>
                    <p style="font-size:0.95rem;opacity:0.9">Ù„Ù‚Ø¯ Ø§Ø³ØªÙ‡Ù„ÙƒØª Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©.</p>
                    <button class="upgrade-btn" onclick="openUpgrade()">ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¢Ù†</button>
                </div>
            `;
            return;
        }

        if (!res.ok) throw new Error(data.message || 'Server error: ' + res.status);
        status.style.display = 'none';

        if (!data.results || !data.results.length) {
            status.style.display = 'block';
            status.innerText = UI.noResults;
            return;
        }

        // Display personality if available
        if (data.personality) {
            personalityContainer.innerHTML = `
                <div class="personality-badge">
                    <div class="personality-icon">${data.personality.icon}</div>
                    <div class="personality-info">
                        <div class="personality-type">${data.personality.name}</div>
                        <div class="personality-desc">Ù†Ù…Ø· Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</div>
                    </div>
                </div>
            `;
            personalityContainer.style.display = 'block';
        }

        // Render each product card
        data.results.forEach(product => {
            const cardHtml = renderProductCard(product, T);
            resultsBox.innerHTML += cardHtml;
        });

        // Update energy display
        if (data.energy) {
            const rCount = document.getElementById('r-count');
            if (rCount) {
                rCount.textContent = data.energy.left === 'âˆ' ? 'âˆ' : data.energy.left;
            }
        }

    } catch (e) {
        status.style.display = 'block';
        status.innerText = UI.errorFetching + ': ' + e.message;
    }
}

// ===== WATCH LIST =====
window.addToWatch = async function(name, price, link) {
    const userEmail = prompt('Ø£Ø¯Ø®Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ùƒ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡:');
    if (!userEmail || !userEmail.includes('@')) return;
    
    const numericPrice = parseFloat(String(price).replace(/[^\d.]/g, '')) || 0;
    
    try {
        const response = await fetch(API + '/alerts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: userEmail,
                productName: name,
                targetPrice: numericPrice * 0.9,
                currentPrice: numericPrice,
                productLink: link,
                lang: lang
            })
        });
        
        if (response.ok) {
            alert('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡!');
        } else {
            alert('âŒ Ø®Ø·Ø£: ' + response.status);
        }
    } catch (error) {
        alert('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„');
    }
};

// ===== CHAT FUNCTIONS =====
function initChat() {
    const chatFab = document.getElementById('chat-fab');
    const chatCloseBtn = document.getElementById('chat-close-btn');
    const chatSendBtn = document.getElementById('chat-send');
    
    if (chatFab) chatFab.addEventListener('click', toggleChat);
    if (chatCloseBtn) chatCloseBtn.addEventListener('click', toggleChat);
    if (chatSendBtn) chatSendBtn.addEventListener('click', sendChatMessage);
    
    updateChatUI();
}

function toggleChat() {
    isChatOpen = !isChatOpen;
    const chatWindow = document.getElementById('chat-window');
    const fabIcon = document.getElementById('chat-fab-icon');
    if (isChatOpen) {
        chatWindow.classList.add('active');
        fabIcon.className = 'fa-solid fa-times';
    } else {
        chatWindow.classList.remove('active');
        fabIcon.className = 'fa-solid fa-comments';
    }
}

function updateChatUI() {
    const chatWelcome = document.getElementById('chat-welcome');
    const chatInput = document.getElementById('chat-input');
    
    if (chatWelcome) chatWelcome.textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹ Ø£Ù†Ø§ SageØŒ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªØ³ÙˆÙ‚. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ';
    if (chatInput) chatInput.placeholder = 'Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...';
}

async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (!message) return;
    
    const messagesContainer = document.getElementById('chat-messages');
    
    const userMsg = document.createElement('div');
    userMsg.className = 'chat-message user';
    userMsg.textContent = message;
    messagesContainer.appendChild(userMsg);
    
    input.value = '';
    
    try {
        const response = await fetch(API + '/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, history: chatHistory.slice(-10), lang })
        });
        const data = await response.json();
        
        const aiMsg = document.createElement('div');
        aiMsg.className = 'chat-message assistant';
        aiMsg.textContent = data.response || data.reply || 'Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©!';
        messagesContainer.appendChild(aiMsg);
        
        chatHistory.push({ role: 'user', content: message });
        chatHistory.push({ role: 'assistant', content: aiMsg.textContent });
    } catch (error) {
        const errorMsg = document.createElement('div');
        errorMsg.className = 'chat-message assistant';
        errorMsg.textContent = 'Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©!';
        messagesContainer.appendChild(errorMsg);
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ===== VOICE SEARCH =====
function initVoiceSearch() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const micBtn = document.getElementById('mic-btn');
    
    if (!micBtn || !SpeechRecognition) return;
    
    voiceRecognition = new SpeechRecognition();
    voiceRecognition.lang = lang === 'ar' ? 'ar-SA' : 'en-US';
    voiceRecognition.interimResults = false;
    
    const newMicBtn = micBtn.cloneNode(true);
    micBtn.parentNode.replaceChild(newMicBtn, micBtn);
    
    newMicBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (voiceRecognition) {
            try { voiceRecognition.start(); } catch (err) {}
        }
    });
    
    voiceRecognition.onstart = function() { newMicBtn.classList.add('mic-active'); };
    voiceRecognition.onresult = function(event) {
        const searchInput = document.getElementById('s-input');
        if (searchInput) {
            searchInput.value = event.results[0][0].transcript;
            runSearch();
        }
    };
    voiceRecognition.onerror = function() { newMicBtn.classList.remove('mic-active'); };
    voiceRecognition.onend = function() { newMicBtn.classList.remove('mic-active'); };
}

// ===== UI FUNCTIONS =====
window.toggleMode = function() { document.body.classList.toggle('light-mode'); };
window.toggleLMenu = function() { const m = document.getElementById('l-menu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; };
window.setLang = function(l) { lang = l; localStorage.setItem('findly_lang', l); document.getElementById('l-menu').style.display = 'none'; update(); updateChatUI(); initVoiceSearch(); };
window.quickSearch = function(q) { document.getElementById('s-input').value = q; runSearch(); };
window.quickFilter = function(type) { document.getElementById('s-input').value += ' ' + type; };
window.openUpgrade = async function() {
    const uid = localStorage.getItem('findly_uid') || 'guest_' + Date.now();
    try {
        const res = await fetch(API + '/create-payment', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ uid }) });
        const data = await res.json();
        if (data.url) window.open(data.url, '_blank');
        else alert('âš ï¸ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¯ÙØ¹ ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
    } catch (e) { alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¯ÙØ¹'); }
};

function update() {
    const d = dict[lang] || dict.en || dict.ar;
    if (!d) return;
    
    const userName = localStorage.getItem('fn') || (lang === 'ar' ? 'Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø¨Ø§Ø­Ø«' : 'Seeker');
    
    const elements = {
        'txt-energy': d.ui.energy,
        'greeting': d.ui.welcome + ' ' + userName,
        'txt-title': d.ui.title,
        'txt-sub': d.ui.sub,
        'txt-deep': d.ui.deep,
        'tag-cheap': d.ui.cheap,
        'tag-top': d.ui.top,
        'tag-new': d.ui.new,
        'cat-game': d.ui.game,
        'cat-beauty': d.ui.beauty,
        'cat-home': d.ui.home,
        'cat-c1': d.ui.c1,
        'cat-c2': d.ui.c2,
        'cat-c4': d.ui.c4
    };
    
    for (const [id, value] of Object.entries(elements)) {
        const el = document.getElementById(id);
        if (el && value !== null) el.innerText = value;
    }
    
    const searchInput = document.getElementById('s-input');
    if (searchInput) searchInput.placeholder = d.ui.searchPlaceholder || 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...';
    
    const mainHtml = document.getElementById('main-html');
    if (mainHtml) { mainHtml.lang = lang; mainHtml.dir = lang === 'ar' ? 'rtl' : 'ltr'; }
}

function updateAuthUI() {
    const d = dict[lang] || dict.ar;
    if (!d || !d.auth) return;
    
    const loginSubtitle = document.getElementById('login-subtitle');
    const btnLogin = document.getElementById('btn-login');
    const txtOr = document.getElementById('txt-or');
    const txtGoogleBtn = document.getElementById('txt-google-btn');
    
    if (loginSubtitle) loginSubtitle.textContent = d.auth.loginSubtitle || 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹!';
    if (btnLogin) btnLogin.querySelector('span').textContent = d.auth.login || 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    if (txtOr) txtOr.textContent = d.auth.or || 'Ø£Ùˆ';
    if (txtGoogleBtn) txtGoogleBtn.textContent = d.auth.googleBtn || 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¬Ù„';
}

function switchToSignup() {
    const loginView = document.getElementById('login-view');
    const signupView = document.getElementById('signup-view');
    loginView.classList.remove('active');
    signupView.classList.add('active');
}

function switchToLogin() {
    const loginView = document.getElementById('login-view');
    const signupView = document.getElementById('signup-view');
    signupView.classList.remove('active');
    loginView.classList.add('active');
}

// ===== EVENT LISTENERS =====
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) e.target.style.display = 'none';
});

document.addEventListener("DOMContentLoaded", function() {
    const goToSignup = document.getElementById('go-to-signup');
    const goToLogin = document.getElementById('go-to-login');
    if (goToSignup) goToSignup.addEventListener('click', switchToSignup);
    if (goToLogin) goToLogin.addEventListener('click', switchToLogin);
});

window.onload = function() {
    update();
    updateAuthUI();
    initVoiceSearch();
    initChat();
};
</script>
</body>
</html>
