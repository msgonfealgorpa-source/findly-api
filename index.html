<!DOCTYPE html>
<html lang="ar" dir="rtl" id="main-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Findly Sage Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* â€¦ ÙƒÙ„ CSS ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ â€¦ */
    </style>
</head>
<body>

<header>
    <!-- â€¦ Header ÙƒÙ…Ø§ Ù‡Ùˆ â€¦ -->
</header>

<main class="search-area">
    <!-- â€¦ Search UI, Categories, Options ÙƒÙ…Ø§ Ù‡ÙŠ â€¦ -->
    <div id="status" style="display:none; color:var(--primary); font-weight:bold; margin-top:30px; font-size: 1.1rem;"></div>
    <div id="results"></div>
</main>

<!-- â€¦ Modals ÙƒÙ…Ø§ Ù‡ÙŠ â€¦ -->

<script type="module">
    // --- Firebase SDK ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCI_q5lkgRY4133ua4RlG5TeiCqJ5N5KTU",
      authDomain: "findly-ede17.firebaseapp.com",
      projectId: "findly-ede17",
      storageBucket: "findly-ede17.app",
      messagingSenderId: "503212830017",
      appId: "1:503212830017:web:9afb64c19822bbe7f645c0",
      measurementId: "G-X1Q3WDP50N"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    console.log("ğŸ”¥ Findly Firebase Active");
</script>

<script>
    const API = "https://findly-api.onrender.com";
    let lang = localStorage.getItem('findly_lang') || 'ar';
    let savedAttempts = localStorage.getItem('findly_attempts');
    let attempts = (savedAttempts !== null) ? parseInt(savedAttempts) : 3;
    if (savedAttempts === null) localStorage.setItem('findly_attempts', 3);

    let watchList = JSON.parse(localStorage.getItem('findly_watch')) || [];

    const dict = {
        ar: { title: "Ù…Ø³ØªØ´Ø§Ø±Ùƒ Ø§Ù„Ø­ÙƒÙŠÙ…", sub: "Ø¯Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ", energy: "Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù‚Ù„", welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ", game: "Ø£Ù„Ø¹Ø§Ø¨", beauty: "Ø¬Ù…Ø§Ù„", home: "Ù…Ù†Ø²Ù„ Ø°ÙƒÙŠ", c1: "Ù‡ÙˆØ§ØªÙ", c2: "Ù„Ø§Ø¨ØªÙˆØ¨", c4: "Ø³Ø§Ø¹Ø§Øª", p_head: "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ", buy: "Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù† ğŸ›’", watch: "Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³Ø¹Ø± ğŸ””", over: "ÙŠØªØ¬Ø§ÙˆØ² Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ", cheap: "Ø§Ù‚ØªØµØ§Ø¯ÙŠ", top: "Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹", new: "Ø­Ø¯ÙŠØ« Ø¬Ø¯Ø§Ù‹", deep: "ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ", watchTitle: "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©", why: "Ù„Ù…Ø§Ø°Ø§ Ø§Ø®ØªØ±Ù†Ø§ Ù‡Ø°Ø§ØŸ", slow: "Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ³ØªÙŠÙ‚Ø¸.. Ø§Ù†ØªØ¸Ø± Ø«ÙˆØ§Ù†Ù", noAttempts: "âš ï¸ Ø§Ø³ØªÙ†ÙØ¯Øª Ù…Ø­Ø§ÙˆÙ„Ø§ØªÙƒ!" },
        en: { title: "Sage Advisor", sub: "Your smart shopping guide", energy: "Sage Energy", welcome: "Welcome,", game: "Gaming", beauty: "Beauty", home: "Smart Home", c1: "Phones", c2: "Laptops", c4: "Watches", p_head: "Profile", buy: "Buy Now ğŸ›’", watch: "Watch Price ğŸ””", over: "Over Budget!", cheap: "Budget", top: "Top Rated", new: "Newest", deep: "AI Deep Mode", watchTitle: "Watch List", why: "Why this choice?", slow: "Server waking up.. wait", noAttempts: "âš ï¸ No attempts left!" },
        fr: { title: "Conseiller Sage", sub: "Votre guide d'achat intelligent", energy: "Ã‰nergie Sage", welcome: "Bienvenue,", game: "Jeux", beauty: "BeautÃ©", home: "Maison Inte.", c1: "Mobiles", c2: "Laptops", c4: "Montres", p_head: "Profil", buy: "Acheter ğŸ›’", watch: "Surveiller ğŸ””", over: "Hors budget!", cheap: "Ã‰co", top: "Mieux notÃ©s", new: "Nouveau", deep: "Mode Analyse AI", watchTitle: "Liste de veille", why: "Pourquoi ce choix?", slow: "Le serveur se rÃ©veille..", noAttempts: "âš ï¸ Plus d'essais!" },
        de: { title: "Weiser Berater", sub: "Ihr smarter EinkaufsfÃ¼hrer", energy: "Weise Energie", welcome: "Willkommen,", game: "Spiele", beauty: "SchÃ¶nheit", home: "Smart Home", c1: "Handys", c2: "Laptops", c4: "Uhren", p_head: "Profil", buy: "Kaufen ğŸ›’", watch: "Beobachten ğŸ””", over: "Budget Ã¼bersch.", cheap: "GÃ¼nstig", top: "Bestbewertet", new: "Neu", deep: "KI-Analyse-Modus", watchTitle: "Beobachtungsliste", why: "Warum diese Wahl?", slow: "Server wacht auf..", noAttempts: "âš ï¸ Keine Versuche mehr!" },
        es: { title: "Asesor Sabio", sub: "Tu guÃ­a de compras inteligente", energy: "EnergÃ­a Sabia", welcome: "Bienvenido,", game: "Juegos", beauty: "Belleza", home: "Hogar Intelig.", c1: "MÃ³viles", c2: "PortÃ¡tiles", c4: "Relojes", p_head: "Perfil", buy: "Comprar ğŸ›’", watch: "Vigilar ğŸ””", over: "Fuera de presupuesto", cheap: "EconÃ³mico", top: "Mejor valorado", new: "Nuevo", deep: "Modo de anÃ¡lisis IA", watchTitle: "Lista de vigilancia", why: "Â¿Por quÃ© esta elecciÃ³n?", slow: "El servidor estÃ¡ despertando..", noAttempts: "âš ï¸ Â¡No quedan intentos!" },
        tr: { title: "Bilge DanÄ±ÅŸman", sub: "AkÄ±llÄ± alÄ±ÅŸveriÅŸ rehberiniz", energy: "Bilge Enerji", welcome: "HoÅŸ geldiniz,", game: "Oyunlar", beauty: "GÃ¼zellik", home: "AkÄ±llÄ± Ev", c1: "Telefonlar", c2: "Laptoplar", c4: "Saatler", p_head: "Profil", buy: "SatÄ±n Al ğŸ›’", watch: "FiyatÄ± Ä°zle ğŸ””", over: "BÃ¼tÃ§e AÅŸÄ±ldÄ±!", cheap: "Ekonomik", top: "En Ä°yi", new: "Yeni", deep: "Yapay Zeka Analiz", watchTitle: "Ä°zleme Listesi", why: "Neden bu seÃ§im?", slow: "Sunucu uyanÄ±yor.. bekleyin", noAttempts: "âš ï¸ Deneme kalmadÄ±!" }
    };

    // --- Ù‡Ù†Ø§ Ù†Ø¶Ø¹ Ø¯Ø§Ù„Ø© runSearch() Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ---
    async function runSearch() {
        let q = document.getElementById('s-input').value;
        const status = document.getElementById('status');
        const resCon = document.getElementById('results');
        const d = dict[lang] || dict['ar'];
        const userBudget = parseFloat(localStorage.getItem('fb')) || 0;

        if (attempts <= 0) { 
            status.style.display = "block";
            status.innerHTML = d.noAttempts;
            return; 
        }
        if (!q) return;

        status.style.display = "block";
        status.innerHTML = '<i class="fa-solid fa-microchip fa-spin"></i> Finding Best Deals...';
        resCon.innerHTML = "";

        let uid = localStorage.getItem('findly_uid');
        if(!uid) { uid = 'user_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('findly_uid', uid); }

        try {
            const res = await fetch(`${API}/search?q=${encodeURIComponent(q)}&uid=${uid}&lang=${lang}`, { method: 'GET' });
            const data = await res.json();
            status.style.display = "none";

            if (data.results && data.results.length > 0) {
                const prices = data.results.map(i => parseFloat(i.price?.toString().replace(/[^0-9.]/g, '')) || 0).filter(p => p>0);
                const avgPrice = prices.reduce((a,b)=>a+b,0)/(prices.length||1);
                const minPrice = Math.min(...prices);

                data.results.forEach((p, index) => {
                    let cleanPrice = p.price ? p.price.toString().replace(/[^\d.]/g, '') : "0"; 
                    let priceVal = parseFloat(cleanPrice);
                    let budgetAlert = (userBudget > 0 && priceVal > userBudget) ? `<div class="budget-error">âš ï¸ ${d.over} (${userBudget}$)</div>` : "";

                    let analysisHTML = `
                        <div class="analysis-engine">
                            <span class="analysis-label"><i class="fa-solid fa-brain"></i> ${d.why}</span>
                            ${p.smartReason || 'Best match found based on your search.'}
                            <ul style="margin-top:5px; padding-left: 18px; font-size:0.8rem;">
                                <li>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${p.price || 'N/A'}</li>
                                <li>Ù…ØªÙˆØ³Ø· Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚: ${avgPrice.toFixed(2)}</li>
                                <li>Ø£Ù‚Ù„ Ø³Ø¹Ø± Ù…ØªØ§Ø­: ${minPrice}</li>
                                <li>Ø§Ù„Ù…ØµØ¯Ø±: ${p.source || 'N/A'}</li>
                                <li>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${p.rating || 'N/A'} (${p.reviews || 0} Ù…Ø±Ø§Ø¬Ø¹Ø§Øª)</li>
                            </ul>
                        </div>
                    `;

                    setTimeout(() => {
                        resCon.innerHTML += `
                            <div class="product-card">
                                ${budgetAlert}
                                <img src="${p.thumbnail || ''}" onerror="this.src='https://via.placeholder.com/150'">
                                <h3>${p.name}</h3>
                                <div class="price">${p.price || 'N/A'}</div>
                                ${analysisHTML}
                                <div class="btn-group">
                                    <a href="${p.link}" target="_blank" class="action-btn buy-now">${d.buy}</a>
                                    <button class="action-btn watch-later" onclick="addToWatch('${p.name.replace(/'/g, "\\'")}', '${p.price}', '${p.link}')">${d.watch}</button>
                                </div>
                            </div>`;
                    }, index * 100);
                });

                attempts--;
                localStorage.setItem('findly_attempts', attempts);
                update();
            } else {
                status.style.display = "block";
                status.innerHTML = "No results found / Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬";
            }
        } catch (e) {
            console.error(e);
            status.style.display = "block";
            status.innerHTML = `<i class="fa-solid fa-clock-rotate-left"></i> ${d.slow}`;
        }
    }

    // â€¦ ÙƒÙ„ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†ØŒ watchlistØŒ toggleØŒ update â€¦ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ â€¦
</script>

</body>
</html>
