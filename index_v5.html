<!DOCTYPE html>
<html lang="ar" dir="rtl" id="main-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Findly Sage v5.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-glow: rgba(139, 92, 246, 0.5);
            --secondary: #6366f1;
            --bg-dark: #020617;
            --bg-card: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --gradient: linear-gradient(135deg, #6366F1, #A855F7);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }
        .light-mode {
            --bg-dark: #f8fafc;
            --bg-card: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(0, 0, 0, 0.05);
            --text: #1e293b;
            --text-muted: #64748b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, transparent 50%);
            color: var(--text);
            font-family: 'Readex Pro', sans-serif;
            margin: 0;
            transition: background 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-tools { display: flex; gap: 10px; }
        .tool-btn {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            color: var(--text);
            width: 42px;
            height: 42px;
            border-radius: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .tool-btn:hover { transform: translateY(-2px); border-color: var(--primary); }
        
        /* Search Area */
        .search-area { padding: 40px 5%; text-align: center; max-width: 800px; margin: 0 auto; }
        .energy-box {
            background: rgba(168, 85, 247, 0.08);
            border: 1px solid rgba(168, 85, 247, 0.3);
            padding: 8px 20px;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        h1#txt-title {
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
            font-size: 2.5rem;
        }
        .light-mode h1#txt-title {
            background: linear-gradient(to right, #1e293b, #475569);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .search-wrapper { position: relative; max-width: 600px; margin: 0 auto 20px; }
        .search-input {
            width: 100%;
            padding: 18px 70px;
            border-radius: 24px;
            border: 2px solid var(--glass-border);
            background: var(--bg-card);
            color: var(--text);
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            text-align: center;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15); }
        .send-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gradient);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 18px;
            color: #fff;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .send-btn:hover { transform: translateY(-50%) scale(1.05); }
        
        /* Categories */
        .cat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 600px; margin: 30px auto; }
        .cat-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            padding: 15px 10px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .cat-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .cat-card i { font-size: 1.5rem; color: var(--secondary); }
        .cat-card span { font-size: 0.75rem; font-weight: 600; }
        
        /* ========== PRODUCT CARD - PROFESSIONAL DESIGN ========== */
        .product-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            padding: 0;
            margin-top: 25px;
            text-align: right;
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
            animation: slideUp 0.5s ease;
        }
        
        /* Product Header Section */
        .product-header {
            display: flex;
            gap: 16px;
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
        }
        .product-image {
            width: 120px;
            height: 120px;
            border-radius: 16px;
            object-fit: contain;
            background: #fff;
            flex-shrink: 0;
        }
        .product-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .product-title {
            font-size: 1rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            line-height: 1.5;
            color: var(--text);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .product-price {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--success);
            margin: 0;
        }
        .product-store {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        /* Overall Score Badge */
        .overall-score-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--gradient);
            padding: 10px 18px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }
        .overall-score-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
            line-height: 1;
        }
        .overall-score-label {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.8);
            margin-top: 2px;
        }
        
        /* Final Verdict Section */
        .verdict-section {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--glass-border);
        }
        .verdict-icon {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .verdict-icon.buy { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .verdict-icon.wait { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .verdict-icon.avoid { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .verdict-icon.consider { background: rgba(59, 130, 246, 0.15); color: var(--info); }
        .verdict-content { flex: 1; }
        .verdict-decision {
            font-size: 1.1rem;
            font-weight: 800;
            margin: 0 0 4px 0;
        }
        .verdict-reason {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
        }
        .verdict-confidence {
            background: rgba(139, 92, 246, 0.1);
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        /* Intelligence Sections */
        .intel-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
        }
        .intel-section:last-child { border-bottom: none; }
        .intel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .intel-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        .intel-icon.price { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .intel-icon.technical { background: rgba(59, 130, 246, 0.15); color: var(--info); }
        .intel-icon.prediction { background: rgba(168, 85, 247, 0.15); color: var(--primary); }
        .intel-icon.pattern { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .intel-icon.trust { background: rgba(20, 184, 166, 0.15); color: #14b8a6; }
        .intel-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }
        
        /* Price Stats Grid */
        .price-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .price-stat {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
        }
        .price-stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
        }
        .price-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .price-stat.savings .price-stat-value { color: var(--success); }
        
        /* Technical Indicators */
        .tech-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .tech-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 12px;
        }
        .tech-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .tech-item-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }
        .tech-item-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text);
        }
        .tech-item-signal {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
        }
        .tech-item-signal.oversold { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .tech-item-signal.overbought { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .tech-item-signal.neutral { background: rgba(148, 163, 184, 0.2); color: var(--text-muted); }
        .tech-item-signal.bullish { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .tech-item-signal.bearish { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        
        /* Prediction Section */
        .prediction-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .prediction-row:last-child { border-bottom: none; }
        .prediction-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .prediction-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
        }
        .prediction-value.up { color: var(--danger); }
        .prediction-value.down { color: var(--success); }
        .prediction-value.stable { color: var(--text-muted); }
        
        /* Pattern Tags */
        .pattern-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .pattern-tag {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text);
        }
        
        /* Support/Resistance */
        .sr-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .sr-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }
        .sr-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .sr-value {
            font-size: 1rem;
            font-weight: 700;
        }
        .sr-value.support { color: var(--success); }
        .sr-value.resistance { color: var(--danger); }
        
        /* Trust Section */
        .trust-bar-container {
            margin-top: 10px;
        }
        .trust-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .trust-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .trust-bar-fill.high { background: linear-gradient(90deg, #10b981, #22c55e); }
        .trust-bar-fill.medium { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .trust-bar-fill.low { background: linear-gradient(90deg, #ef4444, #f87171); }
        
        /* Risk Warnings */
        .risk-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-top: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .risk-warning-icon {
            font-size: 1.2rem;
            color: var(--danger);
        }
        .risk-warning-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            flex: 1;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            border-top: 1px solid var(--glass-border);
        }
        .action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 14px;
            font-weight: 700;
            text-align: center;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }
        .action-btn.buy-now {
            background: var(--gradient);
            color: #fff;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }
        .action-btn.buy-now:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .action-btn.watch {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }
        .action-btn.watch:hover { background: rgba(245, 158, 11, 0.25); }
        .action-btn.analyze {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--info);
        }
        .action-btn.analyze:hover { background: rgba(59, 130, 246, 0.25); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Status */
        #status {
            display: none;
            color: var(--primary);
            font-weight: bold;
            margin-top: 30px;
            font-size: 1.1rem;
            text-align: center;
        }
        
        /* Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(12px);
        }
        .modal-box {
            background: #0f172a;
            padding: 30px;
            border-radius: 30px;
            width: 85%;
            max-width: 450px;
            border: 1px solid var(--glass-border);
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-box input {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border-radius: 14px;
            background: #1e293b;
            color: #fff;
            border: 1px solid var(--glass-border);
            text-align: center;
            font-family: inherit;
        }
        .modal-box input:focus { border-color: var(--primary); }
        
        /* Responsive */
        @media (max-width: 600px) {
            .product-header { flex-direction: column; align-items: center; text-align: center; }
            .product-image { width: 150px; height: 150px; }
            .overall-score-badge { position: relative; top: 0; left: 0; margin-bottom: 10px; }
            .price-stats { grid-template-columns: repeat(2, 1fr); }
            .tech-grid { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            h1#txt-title { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo-area">
        <div class="logo">Findly <i class="fa-solid fa-wand-magic-sparkles"></i> <span style="font-size:0.6rem;opacity:0.7">v5.0</span></div>
    </div>
    <div class="header-tools">
        <button class="tool-btn" onclick="toggleMode()" title="Toggle Theme"><i class="fa-solid fa-circle-half-stroke"></i></button>
        <button class="tool-btn" onclick="setLang(lang === 'ar' ? 'en' : 'ar')" title="Language"><i class="fa-solid fa-language"></i></button>
        <button class="tool-btn" onclick="logoutUser()" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></button>
    </div>
</header>

<main class="search-area">
    <div class="energy-box">
        <span id="txt-energy">Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ù‚Ù„</span>
        <span id="r-count" style="background:var(--primary); color:#fff; padding:3px 12px; border-radius:20px; font-weight:900; font-size: 0.9rem;">âˆ</span>
        <i class="fa-solid fa-bolt" style="color:#FFD700;"></i>
    </div>
    <h2 id="greeting" style="color: var(--primary); font-size: 1.1rem; margin-bottom: 5px; font-weight: 600;"></h2>
    <h1 id="txt-title">Ù…Ø³ØªØ´Ø§Ø±Ùƒ Ø§Ù„Ø­ÙƒÙŠÙ…</h1>
    <p id="txt-sub" style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 30px;">Ø¯Ù„ÙŠÙ„Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ</p>
    
    <div class="search-wrapper">
        <input type="text" id="s-input" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." onkeypress="if(event.key==='Enter')runSearch()">
        <button class="send-btn" onclick="runSearch()"><i class="fa-solid fa-magnifying-glass"></i></button>
    </div>
    
    <div class="cat-grid">
        <div class="cat-card" onclick="quickSearch('iPhone 15')"><i class="fa-solid fa-mobile-screen-button"></i><span>Ù‡ÙˆØ§ØªÙ</span></div>
        <div class="cat-card" onclick="quickSearch('Laptop')"><i class="fa-solid fa-laptop"></i><span>Ù„Ø§Ø¨ØªÙˆØ¨</span></div>
        <div class="cat-card" onclick="quickSearch('Headphones')"><i class="fa-solid fa-headphones"></i><span>Ø³Ù…Ø§Ø¹Ø§Øª</span></div>
        <div class="cat-card" onclick="quickSearch('Gaming')"><i class="fa-solid fa-gamepad"></i><span>Ø£Ù„Ø¹Ø§Ø¨</span></div>
        <div class="cat-card" onclick="quickSearch('Watch')"><i class="fa-solid fa-stopwatch"></i><span>Ø³Ø§Ø¹Ø§Øª</span></div>
        <div class="cat-card" onclick="quickSearch('Camera')"><i class="fa-solid fa-camera"></i><span>ÙƒØ§Ù…ÙŠØ±Ø§Øª</span></div>
    </div>
    
    <div id="status"></div>
    <div id="results"></div>
</main>

<!-- Auth Modal -->
<div id="auth-modal" class="modal" style="display:none !important;"></div>

<!-- Profile Modal -->
<div class="modal" id="p-modal">
    <div class="modal-box">
        <h3 id="p-head" style="margin-top:0;">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
        <label style="font-size:0.85rem; display:block; margin-bottom:5px; opacity:0.7;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input type="text" id="in-name" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <label style="font-size:0.85rem; display:block; margin-top:15px; margin-bottom:5px; opacity:0.7;">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ($)</label>
        <input type="number" id="in-budget" placeholder="0">
        <button class="action-btn buy-now" onclick="saveSet()" style="width:100%; margin-top:20px;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª âœ…</button>
        <button onclick="document.getElementById('p-modal').style.display='none'" style="background:none; color:var(--text-muted); border:none; margin-top:15px; cursor:pointer; font-size:0.9rem;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<!-- Analysis Modal -->
<div class="modal" id="analysis-modal">
    <div class="modal-box">
        <h3 id="analysis-modal-title" style="color:var(--primary); margin-top:0;">ğŸ§  Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h3>
        <div id="analysis-content-body"></div>
        <button class="action-btn buy-now" style="margin-top:20px; width:100%" onclick="document.getElementById('analysis-modal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
const API = "https://findly-api-production.up.railway.app";
let lang = localStorage.getItem('findly_lang') || 'ar';

// ===== MAIN SEARCH FUNCTION =====
async function runSearch() {
    const q = document.getElementById('s-input').value.trim();
    const status = document.getElementById('status');
    const resultsBox = document.getElementById('results');

    if (!q) return;

    status.style.display = 'block';
    status.innerText = 'ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
    resultsBox.innerHTML = '';

    try {
        const res = await fetch(API + '/search?q=' + encodeURIComponent(q) + '&lang=' + lang);
        const data = await res.json().catch(() => ({}));

        if (res.status === 429 || data.error === 'ENERGY_EMPTY') {
            status.innerHTML = '<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);padding:20px;border-radius:16px;text-align:center;"><h3>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</h3><p style="font-size:0.9rem;opacity:0.8">Ù„Ù‚Ø¯ Ø§Ø³ØªÙ‡Ù„ÙƒØª Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</p><button onclick="openUpgrade()" style="background:var(--gradient);color:white;padding:12px 24px;border:none;border-radius:12px;cursor:pointer;font-weight:600;margin-top:10px;">ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¢Ù†</button></div>';
            return;
        }

        if (!res.ok) throw new Error(data.message || 'Server error');

        status.style.display = 'none';

        if (!data.results || !data.results.length) {
            status.style.display = 'block';
            status.innerText = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬';
            return;
        }

        data.results.forEach(p => renderProductCard(p));

    } catch (e) {
        status.style.display = 'block';
        status.innerText = 'âŒ Ø®Ø·Ø£: ' + e.message;
    }
}

// ===== RENDER PRODUCT CARD =====
function renderProductCard(p) {
    const resultsBox = document.getElementById('results');
    const intel = p.intelligence || {};
    const verdict = intel.finalVerdict || {};
    const priceIntel = intel.priceIntel || {};
    const technicalIntel = intel.technicalIntel || {};
    const predictionIntel = intel.predictionIntel || {};
    const patternIntel = intel.patternIntel || {};
    const trustIntel = intel.trustIntel || {};
    const merchantTrust = trustIntel.merchantTrust || {};

    const priceVal = parseFloat(String(p.price).replace(/[^\d.]/g, '')) || 0;
    const overallScore = verdict.overallScore || priceIntel.score || 50;

    // Determine verdict class
    let verdictClass = 'consider';
    let verdictIcon = 'ğŸ¤”';
    let verdictText = 'ÙÙƒØ± ÙÙŠ Ø§Ù„Ø£Ù…Ø±';
    if (verdict.decision === 'BUY_NOW') { verdictClass = 'buy'; verdictIcon = 'âœ…'; verdictText = 'Ø§Ø´ØªØ±Ù Ø§Ù„Ø¢Ù†'; }
    else if (verdict.decision === 'BUY') { verdictClass = 'buy'; verdictIcon = 'ğŸ‘'; verdictText = 'ØµÙÙ‚Ø© Ø¬ÙŠØ¯Ø©'; }
    else if (verdict.decision === 'WAIT') { verdictClass = 'wait'; verdictIcon = 'â³'; verdictText = 'Ø§Ù†ØªØ¸Ø±'; }
    else if (verdict.decision === 'AVOID') { verdictClass = 'avoid'; verdictIcon = 'ğŸš«'; verdictText = 'ØªØ¬Ù†Ø¨'; }

    const card = document.createElement('div');
    card.className = 'product-card';

    let html = `
        <!-- Overall Score Badge -->
        <div class="overall-score-badge">
            <div class="overall-score-value">${overallScore}%</div>
            <div class="overall-score-label">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…</div>
        </div>

        <!-- Product Header -->
        <div class="product-header">
            <img class="product-image" src="${p.thumbnail || 'https://via.placeholder.com/120'}" onerror="this.src='https://via.placeholder.com/120'">
            <div class="product-info">
                <h3 class="product-title">${p.title || 'Ù…Ù†ØªØ¬'}</h3>
                <div class="product-price">$${priceVal}</div>
                <div class="product-store">ğŸª ${p.source || 'Ù…ØªØ¬Ø±'}</div>
            </div>
        </div>

        <!-- Final Verdict -->
        <div class="verdict-section">
            <div class="verdict-icon ${verdictClass}">${verdictIcon}</div>
            <div class="verdict-content">
                <h4 class="verdict-decision">${verdictText}</h4>
                <p class="verdict-reason">${verdict.reason || ''}</p>
            </div>
            <div class="verdict-confidence">${verdict.confidence || 0}% Ø«Ù‚Ø©</div>
        </div>
    `;

    // Price Intelligence Section
    if (priceIntel.average) {
        html += `
        <div class="intel-section">
            <div class="intel-header">
                <div class="intel-icon price">ğŸ’°</div>
                <h4 class="intel-title">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø±</h4>
            </div>
            <div class="price-stats">
                <div class="price-stat">
                    <div class="price-stat-value">$${priceIntel.average || priceVal}</div>
                    <div class="price-stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³ÙˆÙ‚</div>
                </div>
                <div class="price-stat">
                    <div class="price-stat-value">$${priceIntel.median || priceVal}</div>
                    <div class="price-stat-label">Ø§Ù„ÙˆØ³ÙŠØ·</div>
                </div>
                <div class="price-stat">
                    <div class="price-stat-value">$${priceIntel.min || priceVal}</div>
                    <div class="price-stat-label">Ø£Ù‚Ù„ Ø³Ø¹Ø±</div>
                </div>
                <div class="price-stat savings">
                    <div class="price-stat-value">${priceIntel.savingsPercent || 0}%</div>
                    <div class="price-stat-label">Ø§Ù„ØªÙˆÙÙŠØ±</div>
                </div>
            </div>
        </div>
        `;
    }

    // Technical Indicators Section
    if (technicalIntel.rsi || technicalIntel.macd || technicalIntel.bollinger) {
        html += `
        <div class="intel-section">
            <div class="intel-header">
                <div class="intel-icon technical">ğŸ“Š</div>
                <h4 class="intel-title">Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©</h4>
            </div>
            <div class="tech-grid">
        `;

        // RSI
        if (technicalIntel.rsi) {
            const rsiSignalClass = technicalIntel.rsi.signal === 'oversold' ? 'oversold' : 
                                   technicalIntel.rsi.signal === 'overbought' ? 'overbought' : 'neutral';
            const rsiSignalText = technicalIntel.rsi.signal === 'oversold' ? 'ØªØ´Ø¨Ø¹ Ø¨ÙŠØ¹ÙŠ ğŸ“ˆ' :
                                  technicalIntel.rsi.signal === 'overbought' ? 'ØªØ´Ø¨Ø¹ Ø´Ø±Ø§Ø¦ÙŠ ğŸ“‰' : 'Ù…Ø­Ø§ÙŠØ¯';
            html += `
                <div class="tech-item">
                    <div class="tech-item-header">
                        <span class="tech-item-name">RSI (14)</span>
                        <span class="tech-item-signal ${rsiSignalClass}">${rsiSignalText}</span>
                    </div>
                    <div class="tech-item-value">${technicalIntel.rsi.value}</div>
                </div>
            `;
        }

        // MACD
        if (technicalIntel.macd) {
            const macdSignalClass = technicalIntel.macd.trend === 'bullish' ? 'bullish' : 'bearish';
            const macdSignalText = technicalIntel.macd.trend === 'bullish' ? 'ØµØ§Ø¹Ø¯ ğŸ“ˆ' : 'Ù‡Ø§Ø¨Ø· ğŸ“‰';
            html += `
                <div class="tech-item">
                    <div class="tech-item-header">
                        <span class="tech-item-name">MACD</span>
                        <span class="tech-item-signal ${macdSignalClass}">${macdSignalText}</span>
                    </div>
                    <div class="tech-item-value">${technicalIntel.macd.crossover ? 'ØªÙ‚Ø§Ø·Ø¹ âš¡' : 'â€”'}</div>
                </div>
            `;
        }

        // Bollinger
        if (technicalIntel.bollinger) {
            const bollPosition = technicalIntel.bollinger.position === 'lower' ? 'Ù‚Ø±Ø¨ Ø§Ù„Ø¯Ø¹Ù… âœ…' :
                                 technicalIntel.bollinger.position === 'upper' ? 'Ù‚Ø±Ø¨ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© âš ï¸' : 'ÙˆØ³Ø· Ø§Ù„Ù†Ø·Ø§Ù‚';
            html += `
                <div class="tech-item">
                    <div class="tech-item-header">
                        <span class="tech-item-name">Bollinger Bands</span>
                    </div>
                    <div class="tech-item-value">${bollPosition}</div>
                </div>
            `;
        }

        // EMA
        if (technicalIntel.ema) {
            html += `
                <div class="tech-item">
                    <div class="tech-item-header">
                        <span class="tech-item-name">EMA (20/50)</span>
                    </div>
                    <div class="tech-item-value">${technicalIntel.ema.ema20} / ${technicalIntel.ema.ema50}</div>
                </div>
            `;
        }

        html += `</div></div>`;
    }

    // Prediction Section
    if (predictionIntel.trend) {
        const trendClass = predictionIntel.trend === 'rising' ? 'up' : 
                           predictionIntel.trend === 'falling' ? 'down' : 'stable';
        const trendText = predictionIntel.trend === 'rising' ? 'ğŸ“ˆ Ø§Ø±ØªÙØ§Ø¹ Ù…ØªÙˆÙ‚Ø¹' :
                          predictionIntel.trend === 'falling' ? 'ğŸ“‰ Ø§Ù†Ø®ÙØ§Ø¶ Ù…ØªÙˆÙ‚Ø¹' : 'â¡ï¸ Ø§Ø³ØªÙ‚Ø±Ø§Ø±';
        
        html += `
        <div class="intel-section">
            <div class="intel-header">
                <div class="intel-icon prediction">ğŸ”®</div>
                <h4 class="intel-title">Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª</h4>
            </div>
            <div class="prediction-row">
                <span class="prediction-label">Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</span>
                <span class="prediction-value ${trendClass}">${trendText}</span>
            </div>
            <div class="prediction-row">
                <span class="prediction-label">Ø§Ù„Ø«Ù‚Ø© ÙÙŠ Ø§Ù„ØªÙ†Ø¨Ø¤</span>
                <span class="prediction-value">${predictionIntel.confidence || 0}%</span>
            </div>
            ${predictionIntel.shouldWait !== undefined ? `
            <div class="prediction-row">
                <span class="prediction-label">Ø§Ù„ØªÙˆØµÙŠØ©</span>
                <span class="prediction-value">${predictionIntel.shouldWait ? 'â³ Ø§Ù†ØªØ¸Ø±' : 'âœ… Ø§Ø´ØªØ±Ù Ø§Ù„Ø¢Ù†'}</span>
            </div>
            ` : ''}
            ${predictionIntel.reason ? `
            <div class="prediction-row">
                <span class="prediction-label">Ø§Ù„Ø³Ø¨Ø¨</span>
                <span class="prediction-value">${predictionIntel.reason}</span>
            </div>
            ` : ''}
        </div>
        `;
    }

    // Patterns Section
    if (patternIntel.detected && patternIntel.detected.length > 0) {
        html += `
        <div class="intel-section">
            <div class="intel-header">
                <div class="intel-icon pattern">ğŸ¯</div>
                <h4 class="intel-title">Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ÙƒØªØ´ÙØ©</h4>
            </div>
            <div class="pattern-tags">
                ${patternIntel.detected.map(pattern => `<span class="pattern-tag">${pattern}</span>`).join('')}
            </div>
        </div>
        `;
    }

    // Support/Resistance Section
    if (patternIntel.supportResistance) {
        const sr = patternIntel.supportResistance;
        html += `
        <div class="intel-section">
            <div class="intel-header">
                <div class="intel-icon pattern">ğŸ“</div>
                <h4 class="intel-title">Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©</h4>
            </div>
            <div class="sr-grid">
                <div class="sr-item">
                    <div class="sr-label">Ø£Ù‚ÙˆÙ‰ Ø¯Ø¹Ù…</div>
                    <div class="sr-value support">$${sr.levels?.strongSupport || 'â€”'}</div>
                </div>
                <div class="sr-item">
                    <div class="sr-label">Ø£Ù‚ÙˆÙ‰ Ù…Ù‚Ø§ÙˆÙ…Ø©</div>
                    <div class="sr-value resistance">$${sr.levels?.strongResistance || 'â€”'}</div>
                </div>
            </div>
        </div>
        `;
    }

    // Trust Section
    if (merchantTrust.trustScore !== undefined) {
        const trustClass = merchantTrust.trustScore >= 70 ? 'high' : 
                           merchantTrust.trustScore >= 40 ? 'medium' : 'low';
        const badgeIcon = merchantTrust.badge?.icon || '';
        
        html += `
        <div class="intel-section">
            <div class="intel-header">
                <div class="intel-icon trust">ğŸ›¡ï¸</div>
                <h4 class="intel-title">Ø«Ù‚Ø© Ø§Ù„ØªØ§Ø¬Ø±</h4>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <span style="font-weight:600;">${merchantTrust.store || p.source}</span>
                <span style="font-size:0.85rem;">${badgeIcon} ${merchantTrust.trustScore}%</span>
            </div>
            <div class="trust-bar">
                <div class="trust-bar-fill ${trustClass}" style="width:${merchantTrust.trustScore}%"></div>
            </div>
        </div>
        `;

        // Risk Warning
        if (trustIntel.overallRisk > 50) {
            html += `
            <div class="risk-warning">
                <span class="risk-warning-icon">âš ï¸</span>
                <div class="risk-warning-text">
                    <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ­Ù…Ù„ Ù…Ø®Ø§Ø·Ø± Ø¹Ø§Ù„ÙŠØ©. ØªØ­Ù‚Ù‚ Ø¬ÙŠØ¯Ø§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡.
                </div>
            </div>
            `;
        }
    }

    // Action Buttons
    const safeLink = verdict.bestLink || p.link;
    const hasLink = safeLink && safeLink.startsWith('http');
    
    html += `
        <div class="action-buttons">
            <button class="action-btn watch" onclick="addToWatch('${p.title?.replace(/'/g, "\\'")}', '${priceVal}', '${safeLink || ''}')">
                <i class="fa-solid fa-bell"></i> Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³Ø¹Ø±
            </button>
            ${hasLink ? `
                <a class="action-btn buy-now" href="${API}/go?url=${encodeURIComponent(safeLink)}" target="_blank">
                    <i class="fa-solid fa-cart-shopping"></i> Ø§Ø´ØªØ±Ù Ø§Ù„Ø¢Ù†
                </a>
            ` : `
                <button class="action-btn buy-now" disabled>Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ØªÙˆÙØ±</button>
            `}
        </div>
    `;

    card.innerHTML = html;
    resultsBox.appendChild(card);
}

// ===== HELPER FUNCTIONS =====
window.toggleMode = function() { document.body.classList.toggle('light-mode'); };
window.setLang = function(l) { 
    lang = l; 
    localStorage.setItem('findly_lang', l); 
    document.getElementById('main-html').lang = l;
    document.getElementById('main-html').dir = l === 'ar' ? 'rtl' : 'ltr';
};
window.quickSearch = function(q) { 
    document.getElementById('s-input').value = q; 
    runSearch(); 
};
window.saveSet = function() {
    localStorage.setItem('fn', document.getElementById('in-name').value);
    localStorage.setItem('user_budget', document.getElementById('in-budget').value);
    document.getElementById('p-modal').style.display = 'none';
};
window.addToWatch = function(name, price, link) {
    const email = prompt('Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡:');
    if (!email || !email.includes('@')) return;
    alert('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡!');
};
window.openUpgrade = async function() {
    alert('Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹...');
};
window.logoutUser = function() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        location.reload();
    }
};

// ===== INIT =====
window.onload = function() {
    const userName = localStorage.getItem('fn') || 'Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø¨Ø§Ø­Ø«';
    document.getElementById('greeting').textContent = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ' + userName;
};

// Close modals on outside click
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
    }
});
</script>
</body>
</html>
